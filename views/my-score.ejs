<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="apple-touch-icon" href="/image/btw.png"/> 
    <link rel="icon" type="image/png" href="/image/btw.png"/> 
    <title>ë¶ˆê½ƒí…Œë‹ˆìŠ¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <style>
        html, body { height: 100%; overflow: hidden; margin: 0; }
        .app-container { display: flex; flex-direction: column; height: 100%; }
        .sticky-header { position: static; z-index: 102; border-bottom: 1px solid #eee; height: 60px; flex-shrink: 0; }
        .filter-section { position: static; z-index: 101; padding: 15px; background-color: #f8f9fa; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .filter-section .dropdown-toggle { display: flex; justify-content: space-between; align-items: center; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .dropdown-menu { padding: .75rem; width: 100%; font-size: 0.8rem;}
        .dropdown-menu .checkbox-group { max-height: 200px; overflow-y: auto; margin-bottom: .5rem;}
        .filter-control-links { padding-bottom: .5rem; margin-bottom: .5rem; border-bottom: 1px solid #eee; }
        .filter-control-links a { font-size: .8rem; color: #6c757d; text-decoration: none; margin-left: 10px; }
        .table-responsive { flex-grow: 1; overflow-y: auto; }
        #scoreTable { font-size: 0.8rem; }
        #scoreTable th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 90; }
        #scoreTable .sortable-th { cursor: pointer; }
        .bottom-nav { position: static; border-top: 1px solid #ddd; background-color: white; z-index: 103; flex-shrink: 0; }
        .bottom-nav .nav-link { font-size: 0.9rem; padding: 0.5rem 0; color: #888888; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .bottom-nav .nav-link img { width: 24px; height: 24px; margin-bottom: 4px; filter: grayscale(100%); opacity: 0.3; }
        .bottom-nav .nav-link.active { color: black !important; }
        .bottom-nav .nav-link.active img { filter: none; opacity: 1; }
        #searchToggle .bi-search { font-size: 1.2rem; color: black; margin-right: 15px; }
        .text-deuce { color: darkblue; }
        .text-ad { color: darkgreen; }
        .diff-plus { color: darkblue; }
        .diff-minus { color: darkgreen; }
        /* í–‰ í´ë¦­ì„ ìœ ë„í•˜ê¸° ìœ„í•´ ì»¤ì„œ ëª¨ì–‘ ë³€ê²½ */
        #scoreTable tbody tr { cursor: pointer; }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .modal-body .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .modal-body .stat-item:last-child {
            border-bottom: none;
        }
        .modal-body .stat-value {
            text-align: right;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- í—¤ë” -->
        <div class="d-flex align-items-center sticky-header" style="padding: 0px 5px;">
             <div class="d-flex align-items-center flex-grow-1">
                <img src="/image/btw.png" alt="ë¡œê³ " style="height: 40px; margin-right: 15px;">
                <h5 style="margin-bottom: 0;"><b>ê°œì¸ ìŠ¤ì½”ì–´</b></h5>
            </div>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="filter-section">
             <div class="row g-2">
                <div class="col-4">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" style="font-size: 0.8rem;" type="button" id="periodDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                            ê¸°ê°„: ì „ì²´
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="periodDropdownButton">
                            <% const periods = [
                                { value: 'all', text: 'ì „ì²´' }, { value: '1m', text: 'ìµœê·¼ 1ê°œì›”' },
                                { value: '3m', text: 'ìµœê·¼ 3ê°œì›”' }, { value: '6m', text: 'ìµœê·¼ 6ê°œì›”' },
                                { value: '1y', text: 'ìµœê·¼ 1ë…„' }, { value: '2025', text: '2025ë…„' },
                                { value: '2024', text: '2024ë…„' }
                            ]; %>
                            <% periods.forEach(period => { %>
                                <li><a class="dropdown-item" href="#" onclick="applyFilters({ period: '<%= period.value %>' })"><%= period.text %></a></li>
                            <% }) %>
                        </ul>
                    </div>
                </div>
                <div class="col-4">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" style="font-size: 0.8rem;" type="button" id="typeDropdownButton" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                            ë¶„ë¥˜
                        </button>
                        <div class="dropdown-menu" aria-labelledby="typeDropdownButton">
                            <div class="filter-control-links"><a href="#" onclick="selectAll('typeFilter'); return false;">ì „ì²´ì„ íƒ</a><a href="#" onclick="deselectAll('typeFilter'); return false;">ì „ì²´í•´ì œ</a></div>
                            <div id="typeFilter" class="checkbox-group">
                                <% const types = ['ë‚¨ë‹¨', 'ì—¬ë‹¨', 'ë‚¨ë³µ', 'ì—¬ë³µ', 'í˜¼ë³µ', 'í˜¼ë³µ(ë‚¨3)', 'í˜¼ë³µ(ì—¬3)', 'í˜¼ë‹¨(ë‚¨vsì—¬)', 'í˜¼ë³µ(ë‚¨vsì—¬)']; %>
                                <% types.forEach(type => { %>
                                    <div class="form-check"><input class="form-check-input" type="checkbox" value="<%= type %>" id="type-<%= type %>"><label class="form-check-label" for="type-<%= type %>"><%= type %></label></div>
                                <% }) %>
                            </div>
                            <button class="btn btn-primary btn-sm w-100" onclick="applyFilters()">í™•ì¸</button>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" style="font-size: 0.8rem;" type="button" id="courtDropdownButton" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                            ì½”íŠ¸
                        </button>
                        <div class="dropdown-menu" aria-labelledby="courtDropdownButton">
                            <div class="filter-control-links"><a href="#" onclick="selectAll('courtFilter'); return false;">ì „ì²´ì„ íƒ</a><a href="#" onclick="deselectAll('courtFilter'); return false;">ì „ì²´í•´ì œ</a></div>
                            <div id="courtFilter" class="checkbox-group">
                                <% courts.forEach(court => { %>
                                    <div class="form-check"><input class="form-check-input" type="checkbox" value="<%= court.name %>" id="court-<%= court.name %>"><label class="form-check-label" for="court-<%= court.name %>"><%= court.name %></label></div>
                                <% }) %>
                            </div>
                            <button class="btn btn-primary btn-sm w-100" onclick="applyFilters()">í™•ì¸</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- í…Œì´ë¸” -->
        <div class="table-responsive">
            <table id="scoreTable" class="table table-sm table-striped text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="sortable-th" onclick="sortTable(0)">ì´ë¦„</th>
                        <th class="sortable-th" onclick="sortTable(1)">ê²½ê¸°ìˆ˜</th>
                        <th class="sortable-th" onclick="sortTable(2)">ìŠ¹ë¥ </th>
                        <th class="sortable-th" onclick="sortTable(3)">í¬<br>ë¹„ìœ¨</th>
                        <th class="sortable-th" onclick="sortTable(4)">í¬<br>ìŠ¹ë¥ </th>
                        <th class="sortable-th" onclick="sortTable(5)">ë°±<br>ë¹„ìœ¨</th>
                        <th class="sortable-th" onclick="sortTable(6)">ë°±<br>ìŠ¹ë¥ </th>
                        <th class="sortable-th" onclick="sortTable(7)">í¬-ë°±<br>ìŠ¹ë¥ ì°¨</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <% if (scores && scores.length > 0) { %>
                        <% scores.forEach(player => { %>
                            <tr onclick="showPlayerDetails(this)"
                                data-name="<%= player.name %>"
                                data-matches="<%= player.matches %>"
                                data-wins="<%= player.wins %>"
                                data-losses="<%= player.losses %>"
                                data-draws="<%= player.draws %>"
                                data-win-rate="<%= player.winRate %>"
                                data-deuce-matches="<%= player.deuceMatches %>"
                                data-deuce-wins="<%= player.deuceWins %>"
                                data-deuce-losses="<%= player.deuceLosses %>"
                                data-deuce-draws="<%= player.deuceDraws %>"
                                data-deuce-win-rate="<%= player.deuceWinRate %>"
                                data-deuce-rate="<%= player.deuceRate %>"
                                data-ad-matches="<%= player.adMatches %>"
                                data-ad-wins="<%= player.adWins %>"
                                data-ad-losses="<%= player.adLosses %>"
                                data-ad-draws="<%= player.adDraws %>"
                                data-ad-win-rate="<%= player.adWinRate %>"
                                data-ad-rate="<%= player.adRate %>"
                                data-win-rate-diff="<%= player.winRateDiff %>">
                                <td><strong><%= player.name %></strong></td>
                                <td><%= player.matches %></td>
                                <td>
                                    <span>
                                    <% if (player.winRate > 50) { %><strong><%= player.winRate %>%</strong><% } else { %><%= player.winRate %>%<% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="text-deuce">
                                    <% if (player.deuceRate > 50) { %><strong><%= player.deuceRate %>%</strong><% } else { %><%= player.deuceRate %>%<% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="text-deuce">
                                    <% if (player.deuceWinRate > 50) { %><strong><%= player.deuceWinRate %>%</strong><% } else { %><%= player.deuceWinRate %>%<% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="text-ad">
                                    <% if (player.adRate > 50) { %><strong><%= player.adRate %>%</strong><% } else { %><%= player.adRate %>%<% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="text-ad">
                                    <% if (player.adWinRate > 50) { %><strong><%= player.adWinRate %>%</strong><% } else { %><%= player.adWinRate %>%<% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="<%= player.winRateDiff > 0 ? 'diff-plus' : (player.winRateDiff < 0 ? 'diff-minus' : '') %>">
                                        <%= player.winRateDiff > 0 ? '+' : '' %><%= player.winRateDiff %>%
                                    </span>
                                </td>
                                <td><i class="bi bi-chevron-right text-muted"></i></td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr><td colspan="9" class="text-center p-5">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br><small>í•„í„° ì¡°ê±´ì„ ë³€ê²½í•˜ê±°ë‚˜ ê²½ê¸° ê¸°ë¡ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</small></td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>

        <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="navbar bottom-nav">
            <div class="container d-flex justify-content-around">
                <a class="nav-link" href="/"><img src="/image/free-icon-tennis-8122941.png" alt="ê²½ê¸° ê¸°ë¡" /> <span>ê²½ê¸° ê¸°ë¡</span></a>
                <a class="nav-link active" href="/my-score"><img src="/image/free-icon-individual-11985530.png" alt="ê°œì¸ ìŠ¤ì½”ì–´" /> <span>ê°œì¸ ìŠ¤ì½”ì–´</span></a>
                <a class="nav-link" href="/chemistry"><img src="/image/free-icon-people-2118701.png" alt="ìƒëŒ€ì™€ ì¼€ë¯¸" /> <span>ìƒëŒ€ì™€ ì¼€ë¯¸</span></a>
            </div>
        </nav>
    </div>
    <div class="modal fade" id="playerDetailModal" tabindex="-1" aria-labelledby="playerDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="playerDetailModalLabel"><b><span id="modalPlayerName"></span></b></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="stat-item">
                        <span><strong>ğŸ“Š&nbsp; ì „ì²´</strong></span>
                        <span class="stat-value" id="modalTotalStats"></span>
                    </div>
                    <div class="stat-item">
                        <span id="modalDeuceTitle"></span>
                        <span class="stat-value" id="modalDeuceStats"></span>
                    </div>
                    <div class="stat-item">
                        <span id="modalAdTitle"></span>
                        <span class="stat-value" id="modalAdStats"></span>
                    </div>
                    <div class="stat-item">
                        <span><strong>âš–ï¸&nbsp; í¬-ë°± ìŠ¹ë¥  ì°¨ì´</strong></span>
                        <span class="stat-value" id="modalWinRateDiff"></span>
                    </div>
                    <div class="stat-item">
                        <span></span>
                        <span class="stat-value" id="modalTags"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /**
         * localStorageë¥¼ ì‚¬ìš©í•˜ì—¬ í•„í„° ê°’ì„ ê´€ë¦¬í•˜ëŠ” í—¬í¼ ê°ì²´
         */
        const filterStorage = {
            KEY: 'userFilters', // localStorageì— ì €ì¥ë  í‚¤ ì´ë¦„
            
            // í•„í„° ê°ì²´ë¥¼ ë°›ì•„ì„œ JSON ë¬¸ìì—´ë¡œ ë³€í™˜ í›„ localStorageì— ì €ì¥
            save(filters) {
                localStorage.setItem(this.KEY, JSON.stringify(filters));
            },

            // localStorageì—ì„œ í•„í„° ê°’ì„ ë¶ˆëŸ¬ì™€ JSON ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
            // ì €ì¥ëœ ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ì„ ë°˜í™˜
            load() {
                const filters = localStorage.getItem(this.KEY);
                if (filters) {
                    return JSON.parse(filters);
                }
                // ì €ì¥ëœ ì„¤ì •ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ í•„í„° ê°’ì„ ë°˜í™˜
                return {
                    period: '6m',
                    types: ['ë‚¨ë‹¨', 'ì—¬ë‹¨', 'ë‚¨ë³µ', 'ì—¬ë³µ', 'í˜¼ë³µ'],
                    courts: [],
                    player: null
                };
            }
        };
        
        /**
         * í•„í„°ê°€ ì ìš©ë  ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜.
         * localStorageì˜ ê¸°ì¡´ ê°’ì„ ë³´ì¡´í•˜ë©´ì„œ í˜„ì¬ í˜ì´ì§€ì˜ í•„í„°ë§Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function applyFilters(options = {}) {
            // 1. localStorageì—ì„œ ê¸°ì¡´ í•„í„° ê°’ì„ ë¨¼ì € ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
            let filters = filterStorage.load();

            // 2. í˜„ì¬ UIì— ìˆëŠ” ê³µí†µ í•„í„°(ë¶„ë¥˜, ì½”íŠ¸) ê°’ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¨ ê°ì²´ë¥¼ 'ì—…ë°ì´íŠ¸'í•©ë‹ˆë‹¤.
            const selectedTypes = Array.from(document.querySelectorAll('#typeFilter input:checked')).map(cb => cb.value);
            const selectedCourts = Array.from(document.querySelectorAll('#courtFilter input:checked')).map(cb => cb.value);
            filters.types = selectedTypes;
            filters.courts = selectedCourts;

            // 3. 'ê¸°ì¤€ëŒ€ìƒ' select ë°•ìŠ¤ê°€ 'í˜„ì¬ í˜ì´ì§€ì— ìˆì„ ê²½ìš°ì—ë§Œ' ê°’ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            //    (my-score.ejs ì—ì„œëŠ” ì´ ì½”ë“œê°€ ë¬´ì‹œë˜ë¯€ë¡œ ê¸°ì¡´ player ê°’ì´ ë³´ì¡´ë©ë‹ˆë‹¤.)
            const playerSelect = document.getElementById('playerSelect');
            if (playerSelect) {
                filters.player = playerSelect.value;
            }

            // 4. ì˜µì…˜ìœ¼ë¡œ ì „ë‹¬ëœ ê°’(ê¸°ê°„ ë“œë¡­ë‹¤ìš´ í´ë¦­, ê¸°ì¤€ëŒ€ìƒ ì§ì ‘ ë³€ê²½ ë“±)ì´ ìˆìœ¼ë©´ ìµœì¢…ì ìœ¼ë¡œ ë®ì–´ì”ë‹ˆë‹¤.
            if (options.period) filters.period = options.period;
            if (options.player) filters.player = options.player;

            // 5. ìµœì¢…ì ìœ¼ë¡œ í•©ì³ì§„ í•„í„° ê°ì²´ë¥¼ localStorageì— ì €ì¥í•©ë‹ˆë‹¤.
            filterStorage.save(filters);

            // 6. ì™„ì„±ëœ URLì„ ë§Œë“¤ì–´ í˜ì´ì§€ë¥¼ ì´ë™í•©ë‹ˆë‹¤.
            const currentPath = window.location.pathname;
            const params = new URLSearchParams();
            params.set('period', filters.period);
            if (filters.types.length > 0) params.set('types', filters.types.join(','));
            if (filters.courts.length > 0) params.set('courts', filters.courts.join(','));
            
            // ì´ë™í•˜ë ¤ëŠ” í˜ì´ì§€ê°€ '/chemistry'ê°€ ì•„ë‹ˆë”ë¼ë„, í˜„ì¬ í˜ì´ì§€ê°€ '/chemistry'ë¼ë©´ player íŒŒë¼ë¯¸í„°ë¥¼ ë¶™ì—¬ì¤ë‹ˆë‹¤.
            if (currentPath === '/chemistry' && filters.player) {
                params.set('player', filters.player);
            }
            
            window.location.href = `${currentPath}?${params.toString()}`;
        }

        /**
         * í˜ì´ì§€ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
         * localStorageì— ì €ì¥ëœ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ë§í¬ì˜ hrefë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
         */
        function updateNavLinks() {
            const navLinks = document.querySelectorAll('.bottom-nav .nav-link');
            const savedFilters = filterStorage.load(); // ì €ì¥ëœ í•„í„° ë¶ˆëŸ¬ì˜¤ê¸°
            
            const paramsToCarry = new URLSearchParams();
            paramsToCarry.set('period', savedFilters.period);
            if (savedFilters.types.length > 0) paramsToCarry.set('types', savedFilters.types.join(','));
            if (savedFilters.courts.length > 0) paramsToCarry.set('courts', savedFilters.courts.join(','));

            navLinks.forEach(link => {
                const targetUrl = new URL(link.href, window.location.origin);
                const finalParams = new URLSearchParams(paramsToCarry);

                if (targetUrl.pathname === '/chemistry' && savedFilters.player) {
                    finalParams.set('player', savedFilters.player);
                }
                
                link.href = `${targetUrl.pathname}?${finalParams.toString()}`;
            });
        }

        /**
         * í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ˆê¸°í™” í•¨ìˆ˜
         */
        document.addEventListener('DOMContentLoaded', () => {
            const savedFilters = filterStorage.load();
            
            // --- 1. ì €ì¥ëœ í•„í„° ê°’ìœ¼ë¡œ UI(ë“œë¡­ë‹¤ìš´, ì²´í¬ë°•ìŠ¤ ë“±)ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ---
            const periods = [ { value: 'all', text: 'ì „ì²´' }, { value: '1m', text: 'ìµœê·¼ 1ê°œì›”' }, { value: '3m', text: 'ìµœê·¼ 3ê°œì›”' }, { value: '6m', text: 'ìµœê·¼ 6ê°œì›”' }, { value: '1y', text: 'ìµœê·¼ 1ë…„' }, { value: '2025', text: '2025ë…„' }, { value: '2024', text: '2024ë…„' } ];
            const selectedPeriod = periods.find(p => p.value === savedFilters.period) || periods[3];
            const periodButton = document.getElementById('periodDropdownButton');
            if (periodButton) periodButton.textContent = `ê¸°ê°„: ${selectedPeriod.text}`;

            savedFilters.types.forEach(type => {
                const checkbox = document.getElementById(`type-${type}`);
                if (checkbox) checkbox.checked = true;
            });

            savedFilters.courts.forEach(court => {
                const checkbox = document.getElementById(`court-${court}`);
                if (checkbox) checkbox.checked = true;
            });
            
            const playerSelect = document.getElementById('playerSelect');
            if (playerSelect && savedFilters.player) {
                playerSelect.value = savedFilters.player;
            }

            updateCheckboxDropdownText('typeDropdownButton', 'typeFilter', 'ë¶„ë¥˜');
            updateCheckboxDropdownText('courtDropdownButton', 'courtFilter', 'ì½”íŠ¸');
            
            // --- 2. í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. ---
            updateNavLinks();

            // --- 3. í˜„ì¬ URLì˜ í•„í„°ì™€ ì €ì¥ëœ í•„í„°ê°€ ë‹¤ë¥¸ì§€ í™•ì¸í•˜ê³ , ë‹¤ë¥´ë©´ í˜ì´ì§€ë¥¼ ë¦¬ë¡œë“œí•˜ì—¬ ë™ê¸°í™”í•©ë‹ˆë‹¤. ---
            // ì´ ë¡œì§ì€ ì‚¬ìš©ìê°€ URLì„ ì§ì ‘ ìˆ˜ì •í–ˆê±°ë‚˜, ë‹¤ë¥¸ íƒ­ì—ì„œ í•„í„°ë¥¼ ë³€ê²½í–ˆì„ ë•Œë¥¼ ëŒ€ë¹„í•©ë‹ˆë‹¤.
            const currentURLParams = new URLSearchParams(window.location.search);
            if (currentURLParams.get('period') !== savedFilters.period ||
                currentURLParams.get('types') !== savedFilters.types.join(',')) {
                // í•„í„°ê°€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì €ì¥ëœ í•„í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ URLì„ ë§Œë“¤ì–´ í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤.
                // ì´ë ‡ê²Œ í•¨ìœ¼ë¡œì¨ í•­ìƒ localStorageì˜ ê°’ê³¼ í™”ë©´ì˜ ë‚´ìš©ì´ ì¼ì¹˜í•˜ê²Œ ë©ë‹ˆë‹¤.
                const params = new URLSearchParams();
                params.set('period', savedFilters.period);
                if(savedFilters.types.length > 0) params.set('types', savedFilters.types.join(','));
                if(savedFilters.courts.length > 0) params.set('courts', savedFilters.courts.join(','));
                if(window.location.pathname === '/chemistry' && savedFilters.player) params.set('player', savedFilters.player);

                // replace()ëŠ” íˆìŠ¤í† ë¦¬ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•„ ë’¤ë¡œê°€ê¸° ì‹œ ë¬´í•œë£¨í”„ì— ë¹ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
                window.location.replace(`${window.location.pathname}?${params.toString()}`);
            } else {
            // [ì¶”ê°€] í˜ì´ì§€ê°€ ë¦¬ë¡œë“œë˜ì§€ ì•Šì„ ë•Œ, ê¸°ë³¸ ì •ë ¬ì„ ì ìš©í•©ë‹ˆë‹¤.
            defaultSortTable();
            }
        });

        const currentParams = new URLSearchParams(window.location.search);
        
        function selectAll(filterId) { document.querySelectorAll(`#${filterId} input[type="checkbox"]`).forEach(checkbox => checkbox.checked = true); }
        function deselectAll(filterId) { document.querySelectorAll(`#${filterId} input[type="checkbox"]`).forEach(checkbox => checkbox.checked = false); }
        function updateCheckboxDropdownText(buttonId, filterId, prefix) {
            const button = document.getElementById(buttonId);
            const count = document.querySelectorAll(`#${filterId} input:checked`).length;
            if (count === 0) { button.textContent = prefix; } else { button.textContent = `${prefix}: ${count}ê°œ ì„ íƒ`; }
        }
        const sortState = { columnIndex: 1, ascending: false };
        function sortTable(columnIndex) {
            const table = document.getElementById('scoreTable');
            const tbody = table.querySelector('tbody');
            if (tbody.rows.length <= 1 && tbody.rows[0].cells.length <= 1) { return; }
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (sortState.columnIndex === columnIndex) { sortState.ascending = !sortState.ascending; } else { sortState.columnIndex = columnIndex; sortState.ascending = false; }
            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[columnIndex];
                const cellB = rowB.cells[columnIndex];
                let valA, valB;
                if (columnIndex === 0) {
                    valA = cellA.innerText.trim();
                    valB = cellB.innerText.trim();
                    return sortState.ascending ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    valA = parseFloat(cellA.innerText.replace(/%|\+/g, '').trim());
                    valB = parseFloat(cellB.innerText.replace(/%|\+/g, '').trim());
                    if (isNaN(valA)) valA = -Infinity;
                    if (isNaN(valB)) valB = -Infinity;
                    return sortState.ascending ? valA - valB : valB - valA;
                }
            });
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        /**
         * í˜ì´ì§€ ë¡œë“œ/í•„í„° ë³€ê²½ ì‹œ ê°œì¸ ìŠ¤ì½”ì–´ í…Œì´ë¸”ì˜ ê¸°ë³¸ ì •ë ¬ì„ ì ìš©í•˜ëŠ” í•¨ìˆ˜.
         * ì •ë ¬ ìš°ì„ ìˆœìœ„: 1.ê²½ê¸°ìˆ˜(ë‚´ë¦¼) > 2.ìŠ¹ë¥ (ë‚´ë¦¼)
         */
        function defaultSortTable() {
            const table = document.getElementById('scoreTable');
            const tbody = table.querySelector('tbody');
            if (!tbody || (tbody.rows.length <= 1 && tbody.rows[0].cells.length <= 1)) { return; }

            const rows = Array.from(tbody.querySelectorAll('tr'));

            // ì…€ì˜ í…ìŠ¤íŠ¸ì—ì„œ ìˆ«ì ê°’ë§Œ ì¶”ì¶œí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
            const getValue = (row, index) => {
                const text = row.cells[index].innerText.trim().replace(/%|\+/g, '');
                const value = parseFloat(text);
                return isNaN(value) ? -Infinity : value;
            };

            rows.sort((a, b) => {
                // 1. ê²½ê¸°ìˆ˜ (ë‚´ë¦¼ì°¨ìˆœ)
                const matchesA = getValue(a, 1);
                const matchesB = getValue(b, 1);
                if (matchesA !== matchesB) {
                    return matchesB - matchesA;
                }

                // 2. ìŠ¹ë¥  (ë‚´ë¦¼ì°¨ìˆœ)
                const winRateA = getValue(a, 2);
                const winRateB = getValue(b, 2);
                return winRateB - winRateA;
            });

            // ì •ë ¬ëœ ìˆœì„œëŒ€ë¡œ í–‰ì„ ë‹¤ì‹œ ì¶”ê°€
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // í”Œë ˆì´ì–´ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ì„ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
        let detailModal = null; // ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        function showPlayerDetails(rowElement) {
            const dataset = rowElement.dataset;

            // ë°ì´í„°ì…‹ì—ì„œ ëª¨ë“  ê¸°ë¡ì„ ì •ìˆ˜í˜•ìœ¼ë¡œ ì¶”ì¶œ
            const name = dataset.name;
            const matches = parseInt(dataset.matches);
            const wins = parseInt(dataset.wins);
            const losses = parseInt(dataset.losses);
            const draws = parseInt(dataset.draws);
            const winRate = parseInt(dataset.winRate);

            const deuceMatches = parseInt(dataset.deuceMatches);
            const deuceWins = parseInt(dataset.deuceWins);
            const deuceLosses = parseInt(dataset.deuceLosses);
            const deuceDraws = parseInt(dataset.deuceDraws);
            const deuceWinRate = parseInt(dataset.deuceWinRate);
            const deuceRate = parseInt(dataset.deuceRate);

            const adMatches = parseInt(dataset.adMatches);
            const adWins = parseInt(dataset.adWins);
            const adLosses = parseInt(dataset.adLosses);
            const adDraws = parseInt(dataset.adDraws);
            const adWinRate = parseInt(dataset.adWinRate);
            const adRate = parseInt(dataset.adRate);

            const winRateDiff = parseInt(dataset.winRateDiff);
            
            // --- ì¡°ê±´ë¶€ í…ìŠ¤íŠ¸ ìƒì„±ì„ ìœ„í•œ ë¡œì§ ---
            const drawsText = draws > 0 ? `${draws}ë¬´ ` : '';
            const deuceDrawsText = deuceDraws > 0 ? `${deuceDraws}ë¬´ ` : '';
            const adDrawsText = adDraws > 0 ? `${adDraws}ë¬´ ` : '';

            const winRateText = winRate > 50 ? `<strong>(${winRate}%)</strong>` : `(${winRate}%)`;
            const deuceWinRateText = deuceWinRate > 50 ? `<strong>(${deuceWinRate}%)</strong>` : `(${deuceWinRate}%)`;
            const adWinRateText = adWinRate > 50 ? `<strong>(${adWinRate}%)</strong>` : `(${adWinRate}%)`;

            const deuceRateText = deuceRate > 50 ? `<strong>${deuceRate}%</strong>` : `${deuceRate}%`;
            const adRateText = adRate > 50 ? `<strong>${adRate}%</strong>` : `${adRate}%`;
            
            // [ìˆ˜ì •] ìµœì¢… íƒœê·¸ ìƒì„± ë¡œì§
            const tags = [];
            // 1. í¬ì§€ì…˜ ë¹„ìœ¨ ë¹„êµ
            if (deuceRate > adRate) {
                tags.push('#í¬ë§ì´í•˜ëŠ”');
            } else if (adRate > deuceRate) {
                tags.push('#ë°±ë§ì´í•˜ëŠ”');
            }

            // 2. ìŠ¹ë¥  ë¹„êµ
            if (deuceWinRate > adWinRate) {
                tags.push('#í¬ì¡ì´');
            } else if (adWinRate > deuceWinRate) {
                tags.push('#ë°±ì¡ì´');
            }
            
            // íƒœê·¸ê°€ ì—†ìœ¼ë©´(ë¹„ìœ¨ê³¼ ìŠ¹ë¥ ì´ ëª¨ë‘ ê°™ìœ¼ë©´) ìë™ìœ¼ë¡œ ê³µë°± ì²˜ë¦¬ë¨
            const tagsText = tags.join(' ');
            // --- ë¡œì§ ìˆ˜ì • ë ---


            // ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†Œì— ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('modalPlayerName').textContent = name;
            
            document.getElementById('modalDeuceTitle').innerHTML = `<span class="text-deuce"><strong>ğŸ«±&nbsp; í¬ ë¹„ìœ¨</strong> ${deuceRateText}</span>`;
            document.getElementById('modalAdTitle').innerHTML = `<span class="text-ad"><strong>ğŸ«²&nbsp; ë°± ë¹„ìœ¨</strong> ${adRateText}</span>`;

            document.getElementById('modalTotalStats').innerHTML = `${matches}ì „ ${wins}ìŠ¹ ${drawsText}${losses}íŒ¨ ${winRateText}`;
            document.getElementById('modalDeuceStats').innerHTML = `<span class="text-deuce">${deuceMatches}ì „ ${deuceWins}ìŠ¹ ${deuceDrawsText}${deuceLosses}íŒ¨ ${deuceWinRateText}</span>`;
            document.getElementById('modalAdStats').innerHTML = `<span class="text-ad">${adMatches}ì „ ${adWins}ìŠ¹ ${adDrawsText}${adLosses}íŒ¨ ${adWinRateText}</span>`;

            const diffClass = winRateDiff > 0 ? 'diff-plus' : (winRateDiff < 0 ? 'diff-minus' : '');
            const diffSign = winRateDiff > 0 ? '+' : '';
            document.getElementById('modalWinRateDiff').innerHTML = `<span class="${diffClass}">${diffSign}${winRateDiff}%</span>`;
            
            document.getElementById('modalTags').textContent = tagsText;

            // ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒì„±í•˜ê³ , ìˆìœ¼ë©´ ì¬ì‚¬ìš©
            if (!detailModal) {
                detailModal = new bootstrap.Modal(document.getElementById('playerDetailModal'));
            }
            detailModal.show();
        }
    </script>
</body>
</html>
