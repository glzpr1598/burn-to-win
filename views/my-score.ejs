<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="apple-touch-icon" href="/image/btw.png"/> 
    <link rel="icon" type="image/png" href="/image/btw.png"/> 
    <link rel="stylesheet" href="/css/common.css" />
    <title>Î∂àÍΩÉÌÖåÎãàÏä§</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <style>
        .filter-section { position: static; z-index: 101; padding: 15px; background-color: #f8f9fa; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .filter-section .dropdown-toggle { display: flex; justify-content: space-between; align-items: center; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .dropdown-menu { padding: .75rem; width: 100%; font-size: 0.8rem;}
        .dropdown-menu .checkbox-group { max-height: 250px; overflow-y: auto; margin-bottom: .5rem;}
        .filter-control-links { padding-bottom: .5rem; margin-bottom: .5rem; border-bottom: 1px solid #eee; }
        .filter-control-links a { font-size: .8rem; color: #6c757d; text-decoration: none; margin-left: 10px; }
        .table-responsive { flex-grow: 1; overflow-y: auto; }
        #scoreTable { font-size: 0.8rem; }
        #scoreTable th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 90; }
        #scoreTable .sortable-th { cursor: pointer; }
        #searchToggle .bi-search { font-size: 1.2rem; color: black; margin-right: 15px; }
        .text-deuce { color: darkblue; }
        .text-ad { color: darkgreen; }
        .diff-plus { color: darkblue; }
        .diff-minus { color: darkgreen; }
        #scoreTable tbody tr { cursor: pointer; }
        .modal-body .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .modal-body .stat-item:last-child {
            border-bottom: none;
        }
        .modal-body .stat-value {
            text-align: right;
        }
        .modal-body * {
            font-size: 0.9rem;
        }
        .modal-body .table * {
            font-size: 0.8rem;
        }
        .group-a-bg td { background-color: #ffffff; }
        .group-b-bg td { background-color: #f2f2f2; }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="d-flex align-items-center sticky-header" style="padding: 0px 5px;">
            <div class="d-flex align-items-center flex-grow-1">
                <a href="/schedule">
                    <img src="/image/btw-tran-180x180.png" alt="Î°úÍ≥†" style="height: 40px; margin-right: 5px;">
                </a>
                <a href="/my-score" style="color: black; text-decoration: none;">
                    <h5 style="margin-bottom: 0;"><b>Í∞úÏù∏ Ïä§ÏΩîÏñ¥</b></h5>
                </a>
            </div>
            <i class="bi bi-list hamburger-icon"></i>
        </div>

        <%- include('partials/sidemenu') %>

        <div class="filter-section">
             <div class="row g-2">
                 <div class="col-4">
                     <div class="dropdown">
                         <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" style="font-size: 0.8rem;" type="button" id="periodDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                             Í∏∞Í∞Ñ: Ï†ÑÏ≤¥
                         </button>
                         <ul class="dropdown-menu" aria-labelledby="periodDropdownButton">
                             <% const periods = [
                                 { value: 'all', text: 'Ï†ÑÏ≤¥' }, { value: '1m', text: 'ÏµúÍ∑º 1Í∞úÏõî' },
                                 { value: '3m', text: 'ÏµúÍ∑º 3Í∞úÏõî' }, { value: '6m', text: 'ÏµúÍ∑º 6Í∞úÏõî' },
                                 { value: '1y', text: 'ÏµúÍ∑º 1ÎÖÑ' }, { value: '2025', text: '2025ÎÖÑ' },
                                 { value: '2024', text: '2024ÎÖÑ' }
                             ]; %>
                             <% periods.forEach(period => { %>
                                 <li><a class="dropdown-item" href="#" onclick="applyFilters({ period: '<%= period.value %>' })"><%= period.text %></a></li>
                             <% }) %>
                         </ul>
                     </div>
                 </div>
                 <div class="col-4">
                     <div class="dropdown">
                         <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" style="font-size: 0.8rem;" type="button" id="typeDropdownButton" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                             Î∂ÑÎ•ò
                         </button>
                         <div class="dropdown-menu" aria-labelledby="typeDropdownButton">
                             <div class="filter-control-links"><a href="#" onclick="selectAll('typeFilter'); return false;">Ï†ÑÏ≤¥ÏÑ†ÌÉù</a><a href="#" onclick="deselectAll('typeFilter'); return false;">Ï†ÑÏ≤¥Ìï¥Ï†ú</a></div>
                             <div id="typeFilter" class="checkbox-group">
                                 <% const types = ['ÎÇ®Îã®', 'Ïó¨Îã®', 'ÎÇ®Î≥µ', 'Ïó¨Î≥µ', 'ÌòºÎ≥µ', 'ÌòºÎ≥µ(ÎÇ®3)', 'ÌòºÎ≥µ(Ïó¨3)', 'ÌòºÎã®(ÎÇ®vsÏó¨)', 'ÌòºÎ≥µ(ÎÇ®vsÏó¨)']; %>
                                 <% types.forEach(type => { %>
                                     <div class="form-check"><input class="form-check-input" type="checkbox" value="<%= type %>" id="type-<%= type %>"><label class="form-check-label" for="type-<%= type %>"><%= type %></label></div>
                                 <% }) %>
                             </div>
                             <button class="btn btn-primary btn-sm w-100" onclick="applyFilters()">ÌôïÏù∏</button>
                         </div>
                     </div>
                 </div>
                 <div class="col-4">
                     <div class="dropdown">
                         <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" style="font-size: 0.8rem;" type="button" id="courtDropdownButton" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                             ÏΩîÌä∏
                         </button>
                         <div class="dropdown-menu" aria-labelledby="courtDropdownButton">
                             <div class="filter-control-links"><a href="#" onclick="selectAll('courtFilter'); return false;">Ï†ÑÏ≤¥ÏÑ†ÌÉù</a><a href="#" onclick="deselectAll('courtFilter'); return false;">Ï†ÑÏ≤¥Ìï¥Ï†ú</a></div>
                             <div id="courtFilter" class="checkbox-group">
                                 <% courts.forEach(court => { %>
                                     <div class="form-check"><input class="form-check-input" type="checkbox" value="<%= court.name %>" id="court-<%= court.name %>"><label class="form-check-label" for="court-<%= court.name %>"><%= court.name %></label></div>
                                 <% }) %>
                             </div>
                             <button class="btn btn-primary btn-sm w-100" onclick="applyFilters()">ÌôïÏù∏</button>
                         </div>
                     </div>
                 </div>
             </div>
        </div>

        <div class="table-responsive">
            <table id="scoreTable" class="table table-sm table-striped text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="sortable-th" onclick="sortTable(0)">Ïù¥Î¶Ñ</th>
                        <th class="sortable-th" onclick="sortTable(1)">Í≤ΩÍ∏∞Ïàò</th>
                        <th class="sortable-th" onclick="sortTable(2)">ÏäπÎ•†</th>
                        <th class="sortable-th" onclick="sortTable(3)">Ìè¨<br>ÎπÑÏú®</th>
                        <th class="sortable-th" onclick="sortTable(4)">Ìè¨<br>ÏäπÎ•†</th>
                        <th class="sortable-th" onclick="sortTable(5)">Î∞±<br>ÎπÑÏú®</th>
                        <th class="sortable-th" onclick="sortTable(6)">Î∞±<br>ÏäπÎ•†</th>
                        <th class="sortable-th" onclick="sortTable(7)">Í∞ÄÏ§ë<br>Ìè¨-Î∞±</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <% if (scores && scores.length > 0) { %>
                        <% scores.forEach(player => { %>
                            <tr onclick="showPlayerDetails(this)"
                                data-name="<%= player.name %>"
                                data-matches="<%= player.matches %>"
                                data-wins="<%= player.wins %>"
                                data-losses="<%= player.losses %>"
                                data-draws="<%= player.draws %>"
                                data-win-rate="<%= player.winRate %>"
                                data-deuce-matches="<%= player.deuceMatches %>"
                                data-deuce-wins="<%= player.deuceWins %>"
                                data-deuce-losses="<%= player.deuceLosses %>"
                                data-deuce-draws="<%= player.deuceDraws %>"
                                data-deuce-win-rate="<%= player.deuceWinRate %>"
                                data-deuce-rate="<%= player.deuceRate %>"
                                data-ad-matches="<%= player.adMatches %>"
                                data-ad-wins="<%= player.adWins %>"
                                data-ad-losses="<%= player.adLosses %>"
                                data-ad-draws="<%= player.adDraws %>"
                                data-ad-win-rate="<%= player.adWinRate %>"
                                data-ad-rate="<%= player.adRate %>"
                                data-weighted-diff="<%= player.weightedDiff %>">
                                <td>
                                    <% const gender = genderMap[player.name]; %>
                                    <% const color = gender === 'ÎÇ®' ? '#ddffff' : (gender === 'Ïó¨' ? '#ffffdd' : 'inherit'); %>
                                    <span style="--bg: <%= color %>; background-color: var(--bg);"><%= player.name %></span>
                                </td>
                                <td><%= player.matches %></td>
                                <td>
                                    <span>
                                    <% if (player.winRate > 50) { %><strong><%= player.winRate %>%</strong><% } else { %><%= player.winRate %>%<% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="text-deuce">
                                    <% if (player.deuceRate > 50) { %><strong><%= player.deuceRate %>%</strong><% } else { %><%= player.deuceRate %>%<% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="text-deuce">
                                    <% if (player.deuceWinRate > 50) { %><strong><%= player.deuceWinRate %>%</strong><% } else { %><%= player.deuceWinRate %>%<% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="text-ad">
                                    <% if (player.adRate > 50) { %><strong><%= player.adRate %>%</strong><% } else { %><%= player.adRate %>%<% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="text-ad">
                                    <% if (player.adWinRate > 50) { %><strong><%= player.adWinRate %>%</strong><% } else { %><%= player.adWinRate %>%<% } %>
                                    </span>
                                </td>
                                <td>
                                    <span class="<%= player.weightedDiff > 0 ? 'diff-plus' : (player.weightedDiff < 0 ? 'diff-minus' : '') %>">
                                        <%= player.weightedDiff > 0 ? '+' : '' %><%= player.weightedDiff %>%
                                    </span>
                                </td>
                                <td><i class="bi bi-chevron-right text-muted"></i></td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr><td colspan="9" class="text-center p-5">ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.<br><small>ÌïÑÌÑ∞ Ï°∞Í±¥ÏùÑ Î≥ÄÍ≤ΩÌïòÍ±∞ÎÇò Í≤ΩÍ∏∞ Í∏∞Î°ùÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.</small></td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>

        <%- include('partials/navbar', { currentPage: 'my-score' }) %>
    </div>

    <div class="modal fade" id="playerDetailModal" tabindex="-1" aria-labelledby="playerDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="playerDetailModalLabel"><b><span id="modalPlayerName"></span></b></h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBodyContent" style="padding: 0;">
                    </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/common-filter.js"></script>
    <script>
        function applyFilters(options = {}) {
            let filters = filterStorage.load();
            filters.types = Array.from(document.querySelectorAll('#typeFilter input:checked')).map(cb => cb.value);
            filters.courts = Array.from(document.querySelectorAll('#courtFilter input:checked')).map(cb => cb.value);
            if (options.period) filters.period = options.period;
            filterStorage.save(filters);
            const params = new URLSearchParams();
            params.set('period', filters.period);
            if (filters.types.length > 0) params.set('types', filters.types.join(','));
            if (filters.courts && filters.courts.length > 0) params.set('courts', filters.courts.join(','));
            
            window.location.href = `/my-score?${params.toString()}`;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const savedFilters = filterStorage.load();
            
            const currentParams = new URLSearchParams(window.location.search);
            const savedParams = new URLSearchParams();
            savedParams.set('period', savedFilters.period);
            if (savedFilters.types.length > 0) savedParams.set('types', savedFilters.types.join(','));
            if (savedFilters.courts && savedFilters.courts.length > 0) savedParams.set('courts', savedFilters.courts.join(','));

            if (currentParams.toString() !== savedParams.toString()) {
                window.location.replace(`/my-score?${savedParams.toString()}`);
                return;
            }

            const periods = [ { value: 'all', text: 'Ï†ÑÏ≤¥' }, { value: '1m', text: 'ÏµúÍ∑º 1Í∞úÏõî' }, { value: '3m', text: 'ÏµúÍ∑º 3Í∞úÏõî' }, { value: '6m', text: 'ÏµúÍ∑º 6Í∞úÏõî' }, { value: '1y', text: 'ÏµúÍ∑º 1ÎÖÑ' }, { value: '2025', text: '2025ÎÖÑ' }, { value: '2024', text: '2024ÎÖÑ' } ];
            const selectedPeriod = periods.find(p => p.value === savedFilters.period) || periods[3];
            document.getElementById('periodDropdownButton').textContent = `Í∏∞Í∞Ñ: ${selectedPeriod.text}`;
            document.querySelectorAll('#typeFilter input').forEach(cb => { if (savedFilters.types.includes(cb.value)) cb.checked = true; });
            if (savedFilters.courts) document.querySelectorAll('#courtFilter input').forEach(cb => { if (savedFilters.courts.includes(cb.value)) cb.checked = true; });
            
            updateCheckboxDropdownText('typeDropdownButton', 'typeFilter', 'Î∂ÑÎ•ò');
            updateCheckboxDropdownText('courtDropdownButton', 'courtFilter', 'ÏΩîÌä∏');
            
            defaultSortTable();
        });
        
        const sortState = { columnIndex: 1, ascending: false };
        function sortTable(columnIndex) {
            const table = document.getElementById('scoreTable');
            const tbody = table.querySelector('tbody');
            if (tbody.rows.length <= 1 && tbody.rows[0].cells.length <= 1) { return; }
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (sortState.columnIndex === columnIndex) { sortState.ascending = !sortState.ascending; } else { sortState.columnIndex = columnIndex; sortState.ascending = false; }
            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[columnIndex];
                const cellB = rowB.cells[columnIndex];
                let valA, valB;
                if (columnIndex === 0) {
                    valA = cellA.innerText.trim();
                    valB = cellB.innerText.trim();
                    return sortState.ascending ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    valA = parseFloat(cellA.innerText.replace(/%|\+/g, '').trim());
                    valB = parseFloat(cellB.innerText.replace(/%|\+/g, '').trim());
                    if (isNaN(valA)) valA = -Infinity;
                    if (isNaN(valB)) valB = -Infinity;
                    return sortState.ascending ? valA - valB : valB - valA;
                }
            });
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        function defaultSortTable() {
            const table = document.getElementById('scoreTable');
            const tbody = table.querySelector('tbody');
            if (!tbody || (tbody.rows.length <= 1 && tbody.rows[0].cells.length <= 1)) { return; }
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const getValue = (row, index) => {
                const text = row.cells[index].innerText.trim().replace(/%|\+/g, '');
                const value = parseFloat(text);
                return isNaN(value) ? -Infinity : value;
            };
            rows.sort((a, b) => {
                const matchesA = getValue(a, 1);
                const matchesB = getValue(b, 1);
                if (matchesA !== matchesB) {
                    return matchesB - matchesA;
                }
                const winRateA = getValue(a, 2);
                const winRateB = getValue(b, 2);
                return winRateB - winRateA;
            });
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        let detailModal = null;
        async function showPlayerDetails(rowElement) {
            const dataset = rowElement.dataset;
            const name = dataset.name;
            
            const summaryHtml = buildSummaryHtml(dataset);
            const modalBody = document.getElementById('modalBodyContent');
            modalBody.innerHTML = summaryHtml;

            document.getElementById('modalPlayerName').textContent = name;
            
            if (!detailModal) {
                detailModal = new bootstrap.Modal(document.getElementById('playerDetailModal'));
            }
            detailModal.show();

            const savedFilters = filterStorage.load();
            const params = new URLSearchParams({
                period: savedFilters.period,
                types: savedFilters.types.join(','),
                courts: savedFilters.courts.join(',')
            });
            try {
                const response = await fetch(`/api/matches/player/${name}?${params.toString()}`);
                if (!response.ok) throw new Error('Í≤ΩÍ∏∞ Í∏∞Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                
                const { matches, genderMap } = await response.json();
                
                const tablesHtml = buildPlayerMatchTablesHtml(matches, name, genderMap);
                modalBody.innerHTML += tablesHtml;
            } catch (error) {
                console.error(error);
                modalBody.innerHTML += `<p class="text-center p-3 text-danger">${error.message}</p>`;
            }
        }

        function buildSummaryHtml(dataset) {
            const { name, matches, wins, losses, draws, winRate, deuceMatches, deuceWins, deuceLosses, deuceDraws, deuceWinRate, deuceRate, adMatches, adWins, adLosses, adDraws, adWinRate, adRate, weightedDiff } = dataset;
            const drawsText = parseInt(draws) > 0 ? `${draws}Î¨¥ ` : '';
            const deuceDrawsText = parseInt(deuceDraws) > 0 ? `${deuceDraws}Î¨¥ ` : '';
            const adDrawsText = parseInt(adDraws) > 0 ? `${adDraws}Î¨¥ ` : '';
            const winRateText = parseInt(winRate) > 50 ? `<strong>(${winRate}%)</strong>` : `(${winRate}%)`;
            const deuceWinRateText = parseInt(deuceWinRate) > 50 ? `<strong>(${deuceWinRate}%)</strong>` : `(${deuceWinRate}%)`;
            const adWinRateText = parseInt(adWinRate) > 50 ? `<strong>(${adWinRate}%)</strong>` : `(${adWinRate}%)`;
            const deuceRateText = parseInt(deuceRate) > 50 ? `<strong>${deuceRate}%</strong>` : `${deuceRate}%`;
            const adRateText = parseInt(adRate) > 50 ? `<strong>${adRate}%</strong>` : `${adRate}%`;
            const diffSign = parseInt(weightedDiff) > 0 ? '+' : '';
            const diffClass = parseInt(weightedDiff) > 0 ? 'diff-plus' : (parseInt(weightedDiff) < 0 ? 'diff-minus' : '');
            
            const tags = [];
            if (parseInt(deuceRate) > parseInt(adRate)) tags.push('#Ìè¨ÎßéÏù¥ÌïòÎäî');
            else if (parseInt(adRate) > parseInt(deuceRate)) tags.push('#Î∞±ÎßéÏù¥ÌïòÎäî');
            if (parseInt(deuceWinRate) > parseInt(adWinRate)) tags.push('#Ìè¨Ïû°Ïù¥');
            else if (parseInt(adWinRate) > parseInt(deuceWinRate)) tags.push('#Î∞±Ïû°Ïù¥');

            return `
                <div style="padding: 1rem; border-bottom: 1px solid #dee2e6;">
                    <div class="stat-item">
                        <span><strong>üìä&nbsp; Ï†ÑÏ≤¥</strong></span>
                        <span class="stat-value">${matches}Ï†Ñ ${wins}Ïäπ ${drawsText}${losses}Ìå® ${winRateText}</span>
                    </div>
                    <div class="stat-item text-deuce">
                        <span><strong>ü´±&nbsp; Ìè¨ ÎπÑÏú®</strong> ${deuceRateText}</span>
                        <span class="stat-value text-deuce">${deuceMatches}Ï†Ñ ${deuceWins}Ïäπ ${deuceDrawsText}${deuceLosses}Ìå® ${deuceWinRateText}</span>
                    </div>
                    <div class="stat-item text-ad">
                        <span><strong>ü´≤&nbsp; Î∞± ÎπÑÏú®</strong> ${adRateText}</span>
                        <span class="stat-value text-ad">${adMatches}Ï†Ñ ${adWins}Ïäπ ${adDrawsText}${adLosses}Ìå® ${adWinRateText}</span>
                    </div>
                    <div class="stat-item">
                        <span><strong>‚öñÔ∏è&nbsp; Ìè¨-Î∞± ÏäπÎ¶¨ Í∞ÄÏ§ëÏπò</strong></span>
                        <span class="stat-value ${diffClass}">${diffSign}${weightedDiff}%</span>
                    </div>
                    <div class="stat-item">
                        <span></span>
                        <span class="stat-value">${tags.join(' ')}</span>
                    </div>
                </div>`;
        }
        
        function buildPlayerMatchTablesHtml(matches, basePlayer, genderMap) {
            if (matches.length === 0) {
                return '<p class="text-center p-4">Ìï¥Îãπ Ï°∞Í±¥Ïùò Í≤ΩÍ∏∞ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
            }

            const stylePlayerName = (player, isBold = false) => {
                if (!player) return '';
                const gender = genderMap[player];
                const color = gender === 'ÎÇ®' ? '#ddffff' : (gender === 'Ïó¨' ? '#ffffdd' : 'inherit');
                return `<span style="background-color: ${color}; ${isBold ? 'font-weight: bold;' : ''}">${player}</span>`;
            };

            const deuceMatches = [];
            const adMatches = [];
            matches.forEach(match => {
                if (match.team1_deuce === basePlayer || match.team2_deuce === basePlayer) {
                    deuceMatches.push(match);
                } else if (match.team1_ad === basePlayer || match.team2_ad === basePlayer) {
                    adMatches.push(match);
                }
            });

            const createTable = (title, matchList, titleClass) => {
                if (matchList.length === 0) return '';
                
                let tableHtml = `
                    <div class="mt-3" style="padding: 0 1rem;">
                        <h6 class="p-2" style="border-bottom: 2px solid ${titleClass === 'text-deuce' ? 'darkblue' : 'darkgreen'}; color: ${titleClass === 'text-deuce' ? 'darkblue' : 'darkgreen'};">${title}</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm text-center align-middle text-nowrap" style="font-size: 0.8rem; margin-bottom: 0;">
                            <thead class="table-light">
                                <tr><th>ÎÇ†Ïßú</th><th>ÏΩîÌä∏</th><th>Ïö∞Î¶¨ ÌåÄ</th><th></th><th>ÏÉÅÎåÄ ÌåÄ</th><th>Í≤∞Í≥º</th><th>ÏòÅÏÉÅ</th></tr>
                            </thead>
                            <tbody>`;

                let prevDate = null;
                let prevCourt = null;
                let currentGroupClass = 'group-a-bg';

                matchList.forEach(match => {
                    if (prevDate !== null && (match.date !== prevDate || match.court !== prevCourt)) {
                        currentGroupClass = (currentGroupClass === 'group-a-bg') ? 'group-b-bg' : 'group-a-bg';
                    }
                    prevDate = match.date;
                    prevCourt = match.court;

                    const team1_raw = [match.team1_deuce, match.team1_ad].filter(p => p);
                    const team2_raw = [match.team2_deuce, match.team2_ad].filter(p => p);
                    const isBaseOnTeam1 = team1_raw.includes(basePlayer);
                    
                    const myTeam = isBaseOnTeam1 ? team1_raw : team2_raw;
                    const opponentTeam = isBaseOnTeam1 ? team2_raw : team1_raw;
                    
                    const myTeamScore = isBaseOnTeam1 ? match.team1_score : match.team2_score;
                    const opponentScore = isBaseOnTeam1 ? match.team2_score : match.team1_score;
                    const scoreHtml = myTeamScore > opponentScore ? `<b>${myTeamScore}</b>:${opponentScore}` : myTeamScore < opponentScore ? `${myTeamScore}:<b>${opponentScore}</b>` : `${myTeamScore}:${opponentScore}`;
                    
                    const result = isBaseOnTeam1 ? match.team1_result : match.team2_result;

                    const myTeamFormatted = myTeam.map(p => stylePlayerName(p, p === basePlayer)).join(' ');
                    const opponentTeamFormatted = opponentTeam.map(p => stylePlayerName(p, false)).join(' ');

                    const result_display = result === 'Ïäπ' ? '<span style="color: darkblue;">Ïäπ</span>' : (result === 'Ìå®' ? '<span style="color: darkred;">Ìå®</span>' : '<span>Î¨¥</span>');
                    const videoLink = match.video ? `<a href="${match.video}" target="_blank" rel="noopener" onclick="event.stopPropagation();"><i class="bi bi-youtube text-danger fs-6"></i></a>` : '';
                    const dateDisplay = match.date ? match.date.substring(2) : '';
                    
                    tableHtml += `<tr class="${currentGroupClass}"><td>${dateDisplay}</td><td>${match.court}</td><td>${myTeamFormatted}</td><td>${scoreHtml}</td><td>${opponentTeamFormatted}</td><td>${result_display}</td><td>${videoLink}</td></tr>`;
                });

                tableHtml += '</tbody></table></div>';
                return tableHtml;
            };

            let finalHtml = '';
            finalHtml += createTable('ü´± <strong>ÎìÄÏä§ÏΩîÌä∏(Ìè¨) Í≤ΩÍ∏∞</strong>', deuceMatches, 'text-deuce');
            finalHtml += createTable('ü´≤ <strong>Ïï†ÎìúÏΩîÌä∏(Î∞±) Í≤ΩÍ∏∞</strong>', adMatches, 'text-ad');

            return finalHtml;
        }
    </script>
</body>
</html>