<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="apple-touch-icon" href="/image/btw.png"/>
    <link rel="icon" type="image/png" href="/image/btw.png"/>
    <link rel="stylesheet" href="/css/common.css" />
    <title>ë¶ˆê½ƒí…Œë‹ˆìŠ¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <style>
        .filter-section { position: static; z-index: 101; padding: 15px; background-color: #f8f9fa; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .filter-section .dropdown-toggle { display: flex; justify-content: space-between; align-items: center; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .dropdown-menu { padding: .75rem; width: 100%; font-size: 0.8rem;}
        .dropdown-menu .checkbox-group { max-height: 250px; overflow-y: auto; margin-bottom: .5rem;}
        .filter-control-links { padding-bottom: .5rem; margin-bottom: .5rem; border-bottom: 1px solid #eee; }
        .filter-control-links a { font-size: .8rem; color: #6c757d; text-decoration: none; margin-left: 10px; }
        .table-responsive { flex-grow: 1; overflow-y: auto; }
        #scoreTable { font-size: 0.8rem; }
        #scoreTable th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 90; }
        .sortable-th { cursor: pointer; }
        #searchContainer { display: none; width: 150px; }
        #searchInput { min-width: 100px; }
        #searchToggle .bi-search { font-size: 1.2rem; color: black; }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .modal-body .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .modal-body .stat-item:last-child {
            border-bottom: none;
        }
        .modal-body .stat-value {
            text-align: right;
            font-size: 0.9rem;
        }
        .modal-body * {
            font-size: 0.9rem;
        }
        .modal-body .table * {
            font-size: 0.8rem;
        }
        .group-a-bg td { background-color: #ffffff; }
        .group-b-bg td { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="modal fade" id="matchDetailModal" tabindex="-1" aria-labelledby="matchDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="matchDetailModalLabel">ê²½ê¸° ê¸°ë¡</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="matchDetailModalBody" style="padding: 0;">
                    </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="d-flex align-items-center justify-content-between sticky-header">
            <div class="d-flex align-items-center">
                <a href="/schedule">
                    <img src="/image/btw-tran-180x180.png" alt="ë¡œê³ " style="height: 40px; margin-right: 5px;">
                </a>
                <a href="/chemistry-score" style="color: black; text-decoration: none;">
                    <h5 style="margin-bottom: 0;"><b>ì¼€ë¯¸ ìŠ¤ì½”ì–´</b></h5>
                </a>
            </div>
            <div class="d-flex align-items-center">
                <div id="searchContainer" class="input-group input-group-sm me-2">
                    <input type="text" id="searchInput" class="form-control" placeholder="í˜ì–´ ê²€ìƒ‰" />
                    <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn"><i class="bi bi-x-lg"></i></button>
                </div>
                <a href="#" id="searchToggle" class="me-3"><i class="bi bi-search"></i></a>
                <i class="bi bi-list hamburger-icon"></i>
            </div>
        </div>

        <%- include('partials/sidemenu') %>

        <div class="filter-section">
            <div class="row g-2">
                <div class="col-4">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" style="font-size: 0.8rem;" type="button" id="periodDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">ê¸°ê°„</button>
                        <ul class="dropdown-menu" aria-labelledby="periodDropdownButton">
                             <% const periods = [ { value: 'all', text: 'ì „ì²´' }, { value: '1m', text: 'ìµœê·¼ 1ê°œì›”' }, { value: '3m', text: 'ìµœê·¼ 3ê°œì›”' }, { value: '6m', text: 'ìµœê·¼ 6ê°œì›”' }, { value: '1y', text: 'ìµœê·¼ 1ë…„' }, { value: '2025', text: '2025ë…„' }, { value: '2024', text: '2024ë…„' } ]; %>
                             <% periods.forEach(period => { %>
                                 <li><a class="dropdown-item" href="#" onclick="applyFilters({ period: '<%= period.value %>' })"><%= period.text %></a></li>
                             <% }) %>
                        </ul>
                    </div>
                </div>
                <div class="col-4">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" style="font-size: 0.8rem;" type="button" id="typeDropdownButton" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">ë¶„ë¥˜</button>
                        <div class="dropdown-menu" aria-labelledby="typeDropdownButton">
                            <div class="filter-control-links"><a href="#" onclick="selectAll('typeFilter'); return false;">ì „ì²´ì„ íƒ</a><a href="#" onclick="deselectAll('typeFilter'); return false;">ì „ì²´í•´ì œ</a></div>
                            <div id="typeFilter" class="checkbox-group">
                                 <% const types = ['ë‚¨ë³µ', 'ì—¬ë³µ', 'í˜¼ë³µ', 'í˜¼ë³µ(ë‚¨3)', 'í˜¼ë³µ(ì—¬3)', 'í˜¼ë³µ(ë‚¨vsì—¬)']; %>
                                <% types.forEach(type => { %>
                                    <div class="form-check"><input class="form-check-input" type="checkbox" value="<%= type %>" id="type-<%= type %>"><label class="form-check-label" for="type-<%= type %>"><%= type %></label></div>
                                <% }) %>
                            </div>
                            <button class="btn btn-primary btn-sm w-100" onclick="applyFilters()">í™•ì¸</button>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" style="font-size: 0.8rem;" type="button" id="courtDropdownButton" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">ì½”íŠ¸</button>
                        <div class="dropdown-menu" aria-labelledby="courtDropdownButton">
                            <div class="filter-control-links"><a href="#" onclick="selectAll('courtFilter'); return false;">ì „ì²´ì„ íƒ</a><a href="#" onclick="deselectAll('courtFilter'); return false;">ì „ì²´í•´ì œ</a></div>
                            <div id="courtFilter" class="checkbox-group">
                                 <% courts.forEach(court => { %>
                                    <div class="form-check"><input class="form-check-input" type="checkbox" value="<%= court.name %>" id="court-<%= court.name %>"><label class="form-check-label" for="court-<%= court.name %>"><%= court.name %></label></div>
                                 <% }) %>
                            </div>
                            <button class="btn btn-primary btn-sm w-100" onclick="applyFilters()">í™•ì¸</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table id="scoreTable" class="table table-sm table-striped text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 29%;">í˜ì–´</th>
                        <th class="sortable-th" style="width: 16%;" onclick="sortTable(1, 'num')">ê²½ê¸°ìˆ˜ <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable-th" style="width: 16%;" onclick="sortTable(2, 'num')">ìŠ¹ë¦¬ <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable-th" style="width: 16%;" onclick="sortTable(3, 'num')">íŒ¨ë°° <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable-th" style="width: 18%;" onclick="sortTable(4, 'num')">ìŠ¹ë¥  <i class="bi bi-arrow-down-up"></i></th>
                        <th style="width: 5%;"></th> </tr>
                </thead>
                <tbody id="scoreTbody">
                    <% if (pairData && pairData.length > 0) { %>
                        <% pairData.forEach(item => { %>
                            <tr data-pair="<%= item.pairKey %>" style="cursor: pointer;" onclick="showMatchDetails(this)">
                                <td>
                                    <% item.players.forEach((player, index) => { %>
                                        <% const color = player.gender === 'ë‚¨' ? '#ddffff' : (player.gender === 'ì—¬' ? '#ffffdd' : 'inherit'); %>
                                        <span style="--bg: <%= color %>; background-color: var(--bg);"><%= player.name %></span>
                                        <% if (index === 0) { %> 
                                            <span> </span>
                                        <% } %>
                                    <% }) %>
                                </td>
                                <td><%= item.matches %></td>
                                <td><%= item.wins %></td>
                                <td><%= item.losses %></td>
                                <% if (item.winRate > 50) { %>
                                    <td><strong><%= item.winRate %>%</strong></td>
                                <% } else { %>
                                    <td><%= item.winRate %>%</td>
                                <% } %>
                                <td><i class="bi bi-chevron-right text-muted"></i></td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr><td colspan="6" class="text-center p-5">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br><small>í•„í„° ì¡°ê±´ì„ ë³€ê²½í•˜ê±°ë‚˜ ê²½ê¸° ê¸°ë¡ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</small></td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>

        <%- include('partials/navbar', { currentPage: 'chemistry-score' }) %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/common-filter.js"></script>
    <script>
        function applyFilters(options = {}) {
            let filters = filterStorage.load();
            const singleTypes = filters.types.filter(t => t.includes('ë‹¨'));
            const newDoubleTypes = Array.from(document.querySelectorAll('#typeFilter input:checked')).map(cb => cb.value);
            filters.types = [...new Set([...singleTypes, ...newDoubleTypes])];
            filters.courts = Array.from(document.querySelectorAll('#courtFilter input:checked')).map(cb => cb.value);
            if (options.period) filters.period = options.period;
            filterStorage.save(filters);

            const params = new URLSearchParams();
            params.set('period', filters.period);
            if (newDoubleTypes.length > 0) params.set('types', newDoubleTypes.join(','));
            if (filters.courts && filters.courts.length > 0) params.set('courts', filters.courts.join(','));
            
            window.location.href = `/chemistry-score?${params.toString()}`;
        }

        // --- ì •ë ¬ ë° ê²€ìƒ‰ ë¡œì§ ---
        let sortState = { col: 4, asc: false };
        function sortTable(colIndex, type) {
            const tbody = document.getElementById("scoreTbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            if (rows.length <= 1 && rows[0].children.length <= 1) return;
            sortState.asc = (sortState.col === colIndex) ? !sortState.asc : true;
            sortState.col = colIndex;
            const direction = sortState.asc ? 1 : -1;
            rows.sort((a, b) => {
                let valA = a.children[colIndex].innerText.trim().replace('%', '');
                let valB = b.children[colIndex].innerText.trim().replace('%', '');
                return (parseFloat(valA) - parseFloat(valB)) * direction;
            });
            sortedRows = rows;

            tbody.innerHTML = "";
            rows.forEach(row => tbody.appendChild(row));
            document.querySelectorAll('#scoreTable th i').forEach((icon, index) => {
                const thIndex = icon.parentElement.cellIndex;
                icon.className = 'bi bi-arrow-down-up';
                if (thIndex === sortState.col) {
                    icon.className = sortState.asc ? 'bi bi-sort-up' : 'bi bi-sort-down';
                }
            });
        }

        function defaultSort() {
            const tbody = document.getElementById("scoreTbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            if (rows.length <= 1 && rows[0].children.length <= 1) return;
            rows.sort((a, b) => {
                const matchesA = parseFloat(a.children[1].innerText.trim());
                const matchesB = parseFloat(b.children[1].innerText.trim());
                if (matchesB !== matchesA) return matchesB - matchesA;

                const winRateA = parseFloat(a.children[4].innerText.trim().replace('%', ''));
                const winRateB = parseFloat(b.children[4].innerText.trim().replace('%', ''));
                return winRateB - winRateA;
            });
            sortedRows = rows;

            tbody.innerHTML = "";
            rows.forEach(row => tbody.appendChild(row));
            document.querySelectorAll('#scoreTable th i')[0].className = 'bi bi-sort-down';
        }
        
        let originalRows = [];
        let sortedRows = [];

        function filterTable() {
            const searchInput = document.getElementById('searchInput');
            const searchText = searchInput.value.toLowerCase().trim();
            const keywords = searchText.split(' ').filter(k => k);
            const tbody = document.getElementById('scoreTbody');
            tbody.innerHTML = '';

            // 'sortedRows'ëŠ” EJSì— ì˜í•´ ë Œë”ë§ëœ, ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ ì›ë³¸ TR ìš”ì†Œë“¤ì˜ ë°°ì—´ì…ë‹ˆë‹¤.
            sortedRows.forEach(row => {
                // ê²€ìƒ‰ì–´ ë§¤ì¹­ì€ ê¸°ì¡´ì²˜ëŸ¼ ìŠ¤íƒ€ì¼ì´ ì œê±°ëœ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.
                const pairText = row.querySelector('td:first-child').innerText.toLowerCase();
                const isMatch = keywords.every(keyword => pairText.includes(keyword));

                if (isMatch) {
                    // ì¼ì¹˜í•˜ëŠ” ê²½ìš°, ìŠ¤íƒ€ì¼ì´ í¬í•¨ëœ ì›ë³¸ í–‰ì„ ë³µì œí•©ë‹ˆë‹¤.
                    const newRow = row.cloneNode(true);
                    newRow.addEventListener('click', () => showMatchDetails(newRow));

                    // âœ¨ ê²€ìƒ‰ì–´ê°€ ìˆì„ ë•Œë§Œ í•˜ì´ë¼ì´íŠ¸ ë¡œì§ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
                    if (keywords.length > 0) {
                        const cell = newRow.querySelector('td:first-child');
                        const searchRegex = new RegExp(keywords.join('|'), 'gi');

                        // âœ¨ ì¤‘ìš”: ì…€ ì „ì²´ê°€ ì•„ë‹Œ, ë°°ê²½ìƒ‰ ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ ê° 'span'ì„ ì°¾ì•„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                        const nameSpans = cell.querySelectorAll('span[style]');
                        nameSpans.forEach(span => {
                            // span íƒœê·¸ì™€ ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , ê·¸ ì•ˆì˜ í…ìŠ¤íŠ¸ì—ë§Œ <strong> íƒœê·¸ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
                            span.innerHTML = span.innerText.replace(searchRegex, '<strong>$&</strong>');
                        });
                    }
                    
                    tbody.appendChild(newRow);
                }
            });
        }

        const matchDetailModal = new bootstrap.Modal(document.getElementById('matchDetailModal'));
        
        async function showMatchDetails(rowElement) {
            const pair = rowElement.dataset.pair;
            const stats = {
                matches: rowElement.cells[1].innerText,
                wins: rowElement.cells[2].innerText,
                losses: rowElement.cells[3].innerText,
                winRate: parseFloat(rowElement.cells[4].innerText.replace('%', ''))
            };

            const currentFilters = new URLSearchParams(window.location.search);
            const period = currentFilters.get('period') || '6m';
            const types = currentFilters.get('types') || 'ë‚¨ë³µ,ì—¬ë³µ,í˜¼ë³µ';
            const courts = currentFilters.get('courts') || '';

            try {
                const response = await fetch(`/api/matches/pair?pair=${encodeURIComponent(pair)}&period=${period}&types=${types}&courts=${courts}`);
                if (!response.ok) {
                    throw new Error('ê²½ê¸° ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                // âœ¨ ìˆ˜ì •: genderMap ë°›ê¸°
                const { matches, genderMap } = await response.json();
                
                document.getElementById('matchDetailModalLabel').innerHTML = `<b>${pair.replace('/', ' ')}</b> í˜ì–´`;
                const modalBody = document.getElementById('matchDetailModalBody');
                
                // âœ¨ ìˆ˜ì •: genderMap ì „ë‹¬
                modalBody.innerHTML = buildMatchTableHtml(matches, pair, stats, genderMap);

                matchDetailModal.show();
            } catch (error) {
                console.error('Error fetching match details:', error);
                alert(error.message);
            }
        }
        
        function buildMatchTableHtml(matches, pair, stats, genderMap) {
            const pairTags = [];
            if (stats.matches > 0) {
                if (stats.winRate >= 90) { pairTags.push('#í™˜ìƒì˜ì¼€ë¯¸'); }
                else if (stats.winRate >= 80) { pairTags.push('#ìš°ë¦°ê·¸ëƒ¥ìš´ëª…ì´ì•¼'); }
                else if (stats.winRate >= 70) { pairTags.push('#ì‹œë„ˆì§€í­ë°œ'); }
                else if (stats.winRate >= 60) { pairTags.push('#ê¿€ì¼€ë¯¸'); }
                else if (stats.winRate >= 50) { pairTags.push('#ë¯¿ê³ ê°€ëŠ”ì¡°í•©'); }
                else if (stats.winRate >= 40) { pairTags.push('#í”ë“¤ë¦¬ëŠ”ì¼€ë¯¸'); }
                else if (stats.winRate >= 30) { pairTags.push('#ë¶„ë°œí•˜ì'); }
                else if (stats.winRate >= 20) { pairTags.push('#ëˆˆë¬¼ì˜ë“€ì˜¤'); }
                else if (stats.winRate >= 10) { pairTags.push('#ìŠ¹ë¥ ë„ë§'); }
                else { pairTags.push('#ì¼€ë¯¸ì‹¤ì¢…'); }
            }
            const pairTagsText = pairTags.join(' ');
            const winRateHtml = stats.winRate > 50
                ? `<strong>(${stats.winRate}%)</strong>`
                : `(${stats.winRate}%)`;
            const summaryHtml = `
                <div style="padding: 1rem; border-bottom: 1px solid #dee2e6;">
                    <div class="stat-item">
                        <span><strong>ğŸ“Š ì „ì </strong></span>
                        <span class="stat-value">${stats.matches}ì „ ${stats.wins}ìŠ¹ ${stats.losses}íŒ¨ ${winRateHtml}</span>
                    </div>
                    ${pairTagsText ? `
                    <div class="stat-item">
                        <span></span>
                        <span class="stat-value">${pairTagsText}</span>
                    </div>` : ''}
                </div>
            `;

            // í”Œë ˆì´ì–´ ì´ë¦„ì— ì„±ë³„ì— ë”°ë¥¸ ë°°ê²½ìƒ‰ê³¼ ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
            const stylePlayerName = (player, isBold = false) => {
                if (!player) return '';
                const gender = genderMap[player];
                // ì„±ë³„ì— ë”°ë¼ ë°°ê²½ìƒ‰ ì§€ì •
                const color = gender === 'ë‚¨' ? '#ddffff' : (gender === 'ì—¬' ? '#ffffdd' : 'inherit');
                const content = isBold ? `<strong>${player}</strong>` : player;
                // 'backgrond-color' ì˜¤íƒ€ ìˆ˜ì • ë° ìŠ¤íƒ€ì¼ ì ìš©
                return `<span style="background-color: ${color};">${content}</span>`;
            };

            let tableHtml = '';
            if (matches.length > 0) {
                const [player1, player2] = pair.split('/');
                tableHtml = `
                    <div class="table-responsive">
                        <table class="table table-sm text-center align-middle text-nowrap" style="font-size: 0.8rem;">
                            <thead class="table-light">
                                <tr><th>ë‚ ì§œ</th><th>ì½”íŠ¸</th><th>ìš°ë¦¬ íŒ€</th><th></th><th>ìƒëŒ€ íŒ€</th><th>ê²°ê³¼</th><th>ë¶„ë¥˜</th><th>ì˜ìƒ</th></tr>
                            </thead>
                            <tbody>
                `;
                
                let prevDate = null, prevCourt = null, currentGroupClass = 'group-a-bg';
                matches.forEach(match => {
                    if (prevDate !== null && (match.date !== prevDate || match.court !== prevCourt)) {
                        currentGroupClass = (currentGroupClass === 'group-a-bg') ? 'group-b-bg' : 'group-a-bg';
                    }
                    prevDate = match.date;
                    prevCourt = match.court;

                    const team1Players = [match.team1_deuce, match.team1_ad];
                    const isPairOnTeam1 = team1Players.includes(player1) && team1Players.includes(player2);

                    let myTeamDisplay, opponentTeamDisplay, result, selectedScore, opponentScore;

                    if (isPairOnTeam1) {
                        // ìš°ë¦¬ íŒ€ì´ team1ì¼ ê²½ìš° (ë“€ìŠ¤, ì• ë“œ ìˆœì„œë¡œ í‘œì‹œ)
                        myTeamDisplay = `${stylePlayerName(match.team1_deuce, true)} ${stylePlayerName(match.team1_ad, true)}`;
                        // ìƒëŒ€ íŒ€(team2) ì„ ìˆ˜ë“¤ì—ê²Œë„ ë°°ê²½ìƒ‰ ì ìš©
                        opponentTeamDisplay = `${stylePlayerName(match.team2_deuce)} ${stylePlayerName(match.team2_ad || '')}`;
                        result = match.team1_result;
                        selectedScore = match.team1_score;
                        opponentScore = match.team2_score;
                    } else {
                        // ìš°ë¦¬ íŒ€ì´ team2ì¼ ê²½ìš° (ë“€ìŠ¤, ì• ë“œ ìˆœì„œë¡œ í‘œì‹œ)
                        myTeamDisplay = `${stylePlayerName(match.team2_deuce, true)} ${stylePlayerName(match.team2_ad, true)}`;
                        // ìƒëŒ€ íŒ€(team1) ì„ ìˆ˜ë“¤ì—ê²Œë„ ë°°ê²½ìƒ‰ ì ìš©
                        opponentTeamDisplay = `${stylePlayerName(match.team1_deuce)} ${stylePlayerName(match.team1_ad || '')}`;
                        result = match.team2_result;
                        selectedScore = match.team2_score;
                        opponentScore = match.team1_score;
                    }
                    
                    // ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±°
                    myTeamDisplay = myTeamDisplay.trim();
                    opponentTeamDisplay = opponentTeamDisplay.trim();

                    let resultDisplay;
                    if (result === 'ìŠ¹') { resultDisplay = '<span style="color: darkblue;">ìŠ¹</span>'; } 
                    else if (result === 'íŒ¨') { resultDisplay = '<span style="color: darkred;">íŒ¨</span>'; }
                    else { resultDisplay = '<span>ë¬´</span>'; }
                    
                    const scoreHtml = selectedScore > opponentScore ? `<b>${selectedScore}</b>:${opponentScore}` : selectedScore < opponentScore ? `${selectedScore}:<b>${opponentScore}</b>` : `${selectedScore}:${opponentScore}`;
                    const videoLink = match.video ? `<a href="${match.video}" target="_blank" rel="noopener" onclick="event.stopPropagation();"><i class="bi bi-youtube text-danger fs-6"></i></a>` : '';
                    
                    tableHtml += `
                        <tr class="${currentGroupClass}">
                            <td>${match.date ? match.date.substring(2) : ''}</td>
                            <td>${match.court}</td>
                            <td>${myTeamDisplay}</td>
                            <td>${scoreHtml}</td>
                            <td>${opponentTeamDisplay}</td>
                            <td>${resultDisplay}</td>
                            <td>${match.type}</td>
                            <td>${videoLink}</td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table></div>`;
            } else {
                tableHtml = '<p class="text-center p-4">í•´ë‹¹ ì¡°ê±´ì˜ ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            return summaryHtml + tableHtml;
        }


        document.addEventListener('DOMContentLoaded', () => {
            originalRows = Array.from(document.querySelectorAll('#scoreTbody tr'));

            const savedFilters = filterStorage.load();
            
            const currentParams = new URLSearchParams(window.location.search);
            const scoreTypes = savedFilters.types.filter(t => !t.includes('ë‹¨'));
            const savedParams = new URLSearchParams();
            savedParams.set('period', savedFilters.period);
            if (scoreTypes.length > 0) savedParams.set('types', scoreTypes.join(','));
            if (savedFilters.courts && savedFilters.courts.length > 0) savedParams.set('courts', savedFilters.courts.join(','));

            if (currentParams.toString() !== savedParams.toString()) {
                window.location.replace(`/chemistry-score?${savedParams.toString()}`);
                return;
            }

            const periods = [ { value: 'all', text: 'ì „ì²´' }, { value: '1m', text: 'ìµœê·¼ 1ê°œì›”' }, { value: '3m', text: 'ìµœê·¼ 3ê°œì›”' }, { value: '6m', text: 'ìµœê·¼ 6ê°œì›”' }, { value: '1y', text: 'ìµœê·¼ 1ë…„' }, { value: '2025', text: '2025ë…„' }, { value: '2024', text: '2024ë…„' } ];
            const selectedPeriod = periods.find(p => p.value === savedFilters.period) || periods[3];
            document.getElementById('periodDropdownButton').textContent = `ê¸°ê°„: ${selectedPeriod.text}`;
            document.querySelectorAll('#typeFilter input').forEach(cb => { if (savedFilters.types.includes(cb.value)) cb.checked = true; });
            if (savedFilters.courts) document.querySelectorAll('#courtFilter input').forEach(cb => { if (savedFilters.courts.includes(cb.value)) cb.checked = true; });
            
            updateCheckboxDropdownText('typeDropdownButton', 'typeFilter', 'ë¶„ë¥˜');
            updateCheckboxDropdownText('courtDropdownButton', 'courtFilter', 'ì½”íŠ¸');
            
            defaultSort();
            // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const searchToggle = document.getElementById('searchToggle');
            const searchContainer = document.getElementById('searchContainer');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            const searchInput = document.getElementById('searchInput');
            searchToggle.addEventListener('click', (e) => { e.preventDefault(); searchToggle.style.display = 'none'; searchContainer.style.display = 'flex'; searchInput.focus(); });
            clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; filterTable(); searchContainer.style.display = 'none'; searchToggle.style.display = 'inline-block'; });
            searchInput.addEventListener('keyup', filterTable);
        });

    </script>
</body>
</html>