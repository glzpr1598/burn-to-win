<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="apple-touch-icon" href="/image/btw.png" />
    <link rel="icon" type="image/png" href="/image/btw.png" />
    <link rel="stylesheet" href="/css/common.css" />
    <title>불꽃테니스</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <style>
        .app-container {
            overflow: hidden;
        }
        .content-area {
            flex-grow: 1;
            overflow-y: auto;
        }
        .header-select {
            max-width: 180px;
            font-size: 0.8rem;
        }
        .nav {
            font-size: 0.9rem
        }
        .bracket-table-wrapper {
            width: 100%;
            padding: 0 8px 10px 8px;
        }
        .bracket-table {
            font-size: 0.8rem;
            width: 100%;
            table-layout: fixed;
        }
        .bracket-table th,
        .bracket-table td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            word-break: break-all;
        }
        .bracket-table th:first-child,
        .bracket-table td:first-child {
            width: 30px;
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .match-cell {
            cursor: pointer;
            padding: 4px !important;
            min-width: 100px;
        }
        .match-cell:hover {
            background-color: #e9ecef;
        }
        .team-info {
            display: flex;
            align-items: center;
            padding: 2px 4px;
        }
        .players {
            text-align: center;
            flex: 3;
            word-break: keep-all;
        }
        .score {
            text-align: center;
            font-weight: bold;
            flex: 1;
            padding-left: 5px;
        }
        .winner-bg { background-color: #EBF7FF !important; }
        .loser-bg { background-color: #FFEAEA !important; }
        .compact-view { display: none; }
        .show-compact .compact-view { display: block; }
        .show-compact .full-view { display: none; }
        #player-score-table th { cursor: pointer; }
        .table-responsive {
            font-size: 0.9rem;
            text-align: center;
        }
        .modal-body * {
			font-size: 0.9rem;
		}
		.app-container .btn-sm {
			font-size: 0.8rem;
		}
    </style>
</head>

<body>
    <div class="app-container">
        <div class="d-flex align-items-center sticky-header">
            <a href="/schedule">
                <img src="/image/btw-tran-180x180.png" alt="로고" style="height: 40px; margin-right: 5px;">
            </a>
            <div class="d-flex align-items-center flex-grow-1">
                <select id="scheduleSelector" class="form-select form-select-sm header-select">
                    <option value="">-- 스페셜매치 선택 --</option>
                    <% schedules.forEach(s => { %>
                        <option value="<%= s.id %>" <%= selectedSchedule && selectedSchedule.id == s.id ? 'selected' : '' %>>
                            <%= s.schedule_date.substring(5) %> | <%= s.notes %>
                        </option>
                    <% }); %>
                </select>
            </div>
            <i class="bi bi-list hamburger-icon"></i>
        </div>

        <%- include('partials/sidemenu') %>

        <% if (selectedSchedule) { %>
        <ul class="nav nav-tabs nav-fill px-2" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="bracket-tab" data-bs-toggle="tab" data-bs-target="#bracket-pane" type="button" role="tab">대진표</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="videographer-tab" data-bs-toggle="tab" data-bs-target="#videographer-pane" type="button" role="tab">촬영자</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="score-tab" data-bs-toggle="tab" data-bs-target="#score-pane" type="button" role="tab">개인 스코어</button>
            </li>
        </ul>

        <div class="tab-content content-area" id="myTabContent">
            <div class="tab-pane fade show active" id="bracket-pane" role="tabpanel">
                <div class="p-2 text-end">
                    <div class="form-check form-switch d-inline-block">
                        <label class="form-check-label small" for="opponentToggle">상대팀 보기</label>
                        <input class="form-check-input" type="checkbox" role="switch" id="opponentToggle" checked>
                    </div>
                </div>
                <div class="bracket-table-wrapper">
                    <table class="bracket-table" id="bracketTable">
                        <thead>
                            <tr>
                                <th></th>
                                <% for (let court = 1; court <= selectedSchedule.total_court_num; court++) { %>
                                    <th><%= court %>코트</th>
                                <% } %>
                            </tr>
                        </thead>
                        <tbody>
                            <% for (let round = 1; round <= selectedSchedule.total_round_num; round++) { %>
                                <tr>
                                    <td><%= round %>R</td>
                                    <% for (let court = 1; court <= selectedSchedule.total_court_num; court++) { 
                                        const match = matchData[round] && matchData[round][court] ? matchData[round][court] : null;
                                    %>
                                    <td class="match-cell"
                                        data-schedule-id="<%= selectedSchedule.id %>"
                                        data-round="<%= round %>"
                                        data-court="<%= court %>"
                                        data-match="<%= match ? encodeURIComponent(JSON.stringify(match)) : '' %>">
                                        
                                        <% if (match) { 
                                            // [수정] 무승부 처리를 위한 배경색 로직
                                            let team1_bg = '', team2_bg = '', compact_bg = '';
                                            const t1s = parseInt(match.team1_score);
                                            const t2s = parseInt(match.team2_score);
                                            if (t1s > t2s) {
                                                team1_bg = 'winner-bg'; team2_bg = 'loser-bg'; compact_bg = 'winner-bg';
                                            } else if (t2s > t1s) {
                                                team1_bg = 'loser-bg'; team2_bg = 'winner-bg'; compact_bg = 'loser-bg';
                                            }
                                        %>
                                            <div class="full-view">
                                                <div class="team-info <%= team1_bg %>">
                                                    <div class="players">
                                                        <span><%- stylePlayerName(match.team1_deuce, genderMap) %></span>
                                                        <span><%- stylePlayerName(match.team1_ad, genderMap) %></span>
                                                    </div>
                                                    <div class="score"><%= match.team1_score %></div>
                                                </div>
                                                <div class="team-info <%= team2_bg %>">
                                                    <div class="players">
                                                        <span><%- stylePlayerName(match.team2_deuce, genderMap) %></span>
                                                        <span><%- stylePlayerName(match.team2_ad, genderMap) %></span>
                                                    </div>
                                                    <div class="score"><%= match.team2_score %></div>
                                                </div>
                                            </div>
                                            <div class="compact-view <%= compact_bg %>">
                                                <div>
                                                    <span><%- stylePlayerName(match.team1_deuce, genderMap) %></span>
                                                    <span><%- stylePlayerName(match.team1_ad, genderMap) %></span>
                                                </div>
                                                <div><b><%= match.team1_score %></b> : <%= match.team2_score %></div>
                                            </div>
                                        <% } %>
                                    </td>
                                    <% } %>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="videographer-pane" role="tabpanel">
                 <div class="bracket-table-wrapper mt-2">
                    <table class="bracket-table">
                        <thead>
                            <tr>
                                <th></th>
                                <% for (let court = 1; court <= selectedSchedule.total_court_num; court++) { %>
                                    <th><%= court %>코트</th>
                                <% } %>
                            </tr>
                        </thead>
                        <tbody>
                             <% for (let round = 1; round <= selectedSchedule.total_round_num; round++) { %>
                                <tr>
                                    <td><%= round %>R</td>
                                    <% for (let court = 1; court <= selectedSchedule.total_court_num; court++) { 
                                        const match = matchData[round] && matchData[round][court] ? matchData[round][court] : null;
                                    %>
                                    <td class="match-cell videographer-cell"
                                        data-schedule-id="<%= selectedSchedule.id %>"
                                        data-round="<%= round %>"
                                        data-court="<%= court %>"
                                        data-match="<%= match ? encodeURIComponent(JSON.stringify(match)) : '' %>">
                                        <% if (match && match.videographer) { %>
                                            <%- stylePlayerName(match.videographer, genderMap) %>
                                        <% } %>
                                    </td>
                                    <% } %>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="score-pane" role="tabpanel">
                <div class="p-2 text-end">
                    <div class="form-check form-switch d-inline-block">
                        <label class="form-check-label small" for="scoreOpponentToggle">상대팀 보기</label>
                        <input class="form-check-input" type="checkbox" role="switch" id="scoreOpponentToggle" checked>
                    </div>
                </div>
                <div class="table-responsive p-2">
                    <table class="table table-sm table-striped table-hover" id="player-score-table">
                        <thead class="table-light" style="position: sticky; top: 0;">
                            <tr>
                                <th onclick="sortTable(0, 'number')">순위</th>
                                <th onclick="sortTable(1, 'string')">이름</th>
                                <th onclick="sortTable(2, 'number')">경기수</th>
                                <th onclick="sortTable(3, 'number')">승</th>
                                <th onclick="sortTable(4, 'number')">패</th>
                                <th onclick="sortTable(5, 'number')">승점</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% playerStats.forEach(player => { %>
                            <tr data-player-name="<%= player.name %>">
                                <td><%= player.rank %></td>
                                <td><%- stylePlayerName(player.name, genderMap) %></td>
                                <td><%= player.matches %></td>
                                <td><%= player.wins %></td>
                                <td><%= player.losses %></td>
                                <td><%= player.points > 0 ? '+' : '' %><%= player.points %></td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <% } else { %>
            <div class="content-area d-flex justify-content-center align-items-center">
                <div class="text-center text-muted">
                    <i class="bi bi-calendar-x" style="font-size: 3rem;"></i>
                    <p class="mt-2">상단에서 스페셜매치 일정을 선택해주세요.</p>
                </div>
            </div>
        <% } %>

        <%- include('partials/navbar', { currentPage: 'special-match' }) %>
    </div>
    
    <div class="modal fade" id="matchRecordModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered" style="align-items: start;">
			<div class="modal-content" style="margin-top: 50px;">
				<form id="matchRecordForm">
					<div class="modal-header">
						<h6 class="modal-title"><b>경기 기록</b></h6>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<datalist id="modal-player-list"></datalist>
						<input type="hidden" name="id">
						<input type="hidden" name="schedule_id">
						<input type="hidden" name="round_num">
						<input type="hidden" name="court_num">

						<div class="border p-3 rounded">
							<div class="row">
								<div class="col text-center">
									<label class="form-label small">듀스코트(포)</label>
									<input type="text" class="form-control" name="team1_deuce" list="modal-player-list" required>
								</div>
                                <div class="col-auto d-flex align-items-end p-0">
                                    <button type="button" class="btn swap-btn px-0" data-team="1">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </button>
                                </div>
								<div class="col text-center">
									<label class="form-label small">애드코트(백)</label>
									<input type="text" class="form-control" name="team1_ad" list="modal-player-list">
								</div>
								<div class="col-auto text-center">
									<label class="form-label small">스코어</label>
									<select class="form-select text-center" name="team1_score">
										<% for(let i=0; i <=7; i++) { %><option value="<%= i %>"><%= i %></option><% } %>
									</select>
								</div>
							</div>
						</div>
						<div class="text-center fw-bold my-2">VS</div>
						<div class="border p-3 rounded">
							<div class="row">
								<div class="col text-center">
									<label class="form-label small">듀스코트(포)</label>
									<input type="text" class="form-control" name="team2_deuce" list="modal-player-list" required>
								</div>
                                <div class="col-auto d-flex align-items-end p-0">
                                    <button type="button" class="btn swap-btn px-0" data-team="2">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </button>
                                </div>
								<div class="col text-center">
									<label class="form-label small">애드코트(백)</label>
									<input type="text" class="form-control" name="team2_ad" list="modal-player-list">
								</div>
								<div class="col-auto text-center">
									<label class="form-label small">스코어</label>
									<select class="form-select text-center" name="team2_score">
										<% for(let i=0; i <=7; i++) { %><option value="<%= i %>"><%= i %></option><% } %>
									</select>
								</div>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-sm btn-danger me-auto" id="deleteMatchRecordBtn">삭제</button>
						<button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">취소</button>
						<button type="button" class="btn btn-sm btn-primary" id="saveMatchRecordBtn">저장</button>
					</div>
				</form>
			</div>
		</div>
	</div>

    <div class="modal fade" id="videographerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title"><b>촬영자 지정</b></h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="videographerMatchId">
                    <input type="hidden" id="videographerScheduleId">
                    <input type="hidden" id="videographerRound">
                    <input type="hidden" id="videographerCourt">
                    <label for="videographerName" class="form-label">이름</label>
                    <input type="text" class="form-control" id="videographerName" list="modal-player-list" placeholder="촬영자 이름 입력">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-sm btn-primary" id="saveVideographerBtn">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // URL 파라미터를 관리하는 함수
        function reloadWithActiveTab(tabName) {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('active_tab', tabName);
            window.location.href = currentUrl.toString();
        }

        document.addEventListener('DOMContentLoaded', function () {
            // --- 초기화 ---
            const matchRecordModal = new bootstrap.Modal(document.getElementById('matchRecordModal'));
            const videographerModal = new bootstrap.Modal(document.getElementById('videographerModal'));

            // --- 이벤트 리스너 (페이지 로드 시) ---
            
            // 일정 선택 드롭다운
            document.getElementById('scheduleSelector').addEventListener('change', function() {
                if (this.value) {
                    window.location.href = '/special-match?schedule_id=' + this.value;
                }
            });

            // [수정] 대진표 토글 상태 로드 및 이벤트 핸들러 설정
            const opponentToggle = document.getElementById('opponentToggle');
            if (opponentToggle) {
                // 토글 상태를 화면에 적용하는 함수
                const applyBracketToggleState = () => {
                    const bracketTable = document.getElementById('bracketTable');
                    if (opponentToggle.checked) {
                        bracketTable.classList.remove('show-compact');
                    } else {
                        bracketTable.classList.add('show-compact');
                    }
                };

                // 1. 페이지 로드 시 localStorage에서 상태 불러오기 (없으면 true가 기본값)
                const savedBracketState = localStorage.getItem('bracketOpponentToggleState');
                opponentToggle.checked = savedBracketState === null ? true : JSON.parse(savedBracketState);
                
                // 2. 불러온 상태를 화면에 즉시 적용
                applyBracketToggleState();

                // 3. 토글 변경 시 localStorage에 상태 저장하고 화면에 적용
                opponentToggle.addEventListener('change', function() {
                    localStorage.setItem('bracketOpponentToggleState', this.checked);
                    applyBracketToggleState();
                });
            }

            // [수정] 개인 스코어 토글 상태 로드 및 이벤트 핸들러 설정
            const scoreOpponentToggle = document.getElementById('scoreOpponentToggle');
            if (scoreOpponentToggle) {
                const team1PlayerSet = new Set(<%- JSON.stringify(team1Players || []) %>);
                
                // 토글 상태를 화면에 적용하는 함수
                const applyScoreToggleState = () => {
                    const scoreTableRows = document.querySelectorAll('#player-score-table tbody tr');
                    scoreTableRows.forEach(row => {
                        if (scoreOpponentToggle.checked) {
                            row.style.display = '';
                        } else {
                            const playerName = row.dataset.playerName;
                            row.style.display = team1PlayerSet.has(playerName) ? '' : 'none';
                        }
                    });
                    updatePlayerRanks();
                };

                // 1. 페이지 로드 시 localStorage에서 상태 불러오기 (없으면 true가 기본값)
                const savedScoreState = localStorage.getItem('scoreOpponentToggleState');
                scoreOpponentToggle.checked = savedScoreState === null ? true : JSON.parse(savedScoreState);
                
                // 2. 불러온 상태를 화면에 즉시 적용
                applyScoreToggleState();

                // 3. 토글 변경 시 localStorage에 상태 저장하고 화면에 적용
                scoreOpponentToggle.addEventListener('change', function() {
                    localStorage.setItem('scoreOpponentToggleState', this.checked);
                    applyScoreToggleState();
                });
            }

            // 페이지 로드 시 URL 파라미터를 확인하여 활성 탭 지정
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('active_tab');
            if (activeTab) {
                const tabToActivate = document.getElementById(activeTab + '-tab');
                if (tabToActivate) {
                    const tab = new bootstrap.Tab(tabToActivate);
                    tab.show();
                }
            }

            // 모달 열기 이벤트
            document.querySelectorAll('#bracket-pane .match-cell').forEach(cell => {
                cell.addEventListener('click', () => openMatchRecordModal(cell, matchRecordModal));
            });
            document.querySelectorAll('#videographer-pane .match-cell').forEach(cell => {
                cell.addEventListener('click', () => openVideographerModal(cell, videographerModal));
            });
            
            // 모달 내 버튼 이벤트
            document.getElementById('saveMatchRecordBtn').addEventListener('click', () => saveMatchRecord(matchRecordModal));
            document.getElementById('deleteMatchRecordBtn').addEventListener('click', () => deleteMatchRecord(matchRecordModal));
            document.getElementById('saveVideographerBtn').addEventListener('click', () => saveVideographer(videographerModal));
            document.querySelectorAll('.swap-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const team = this.dataset.team;
                    const form = document.getElementById('matchRecordForm');
                    const deuceInput = form.querySelector(`[name="team${team}_deuce"]`);
                    const adInput = form.querySelector(`[name="team${team}_ad"]`);
                    const tempValue = deuceInput.value;
                    deuceInput.value = adInput.value;
                    adInput.value = tempValue;
                });
            });
            
            // 햄버거 메뉴
            const hamburger = document.querySelector('.hamburger-icon');
            const sideMenu = document.querySelector('.side-menu');
            const overlay = document.querySelector('.overlay');
            hamburger.addEventListener('click', () => {
                sideMenu.classList.toggle('active');
                overlay.classList.toggle('active');
            });
            overlay.addEventListener('click', () => {
                sideMenu.classList.remove('active');
                overlay.classList.remove('active');
            });
        });

        // --- 이하 함수들은 기존과 동일 ---
        function updatePlayerRanks() {
            const scoreTableRows = Array.from(document.querySelectorAll('#player-score-table tbody tr'));
            const visibleRows = scoreTableRows.filter(row => row.style.display !== 'none');
            const playersToSort = visibleRows.map(row => ({
                rankCell: row.cells[0],
                points: parseFloat(row.cells[5].innerText.replace('+', ''))
            }));
            playersToSort.sort((a, b) => b.points - a.points);
            let rank = 1;
            for (let i = 0; i < playersToSort.length; i++) {
                if (i > 0 && playersToSort[i].points < playersToSort[i - 1].points) {
                    rank = i + 1;
                }
                playersToSort[i].rankCell.innerText = rank;
            }
        }

        async function saveMatchRecord(modalInstance) {
            const form = document.getElementById('matchRecordForm');
            if (!form.reportValidity()) return; // HTML5 required 속성 검사
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            if (!data.team1_deuce || !data.team2_deuce) {
                alert('각 팀의 듀스코트(포핸드) 선수는 필수 입력 항목입니다.');
                return;
            }
            try {
                const response = await fetch('/api/special-match/record', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    modalInstance.hide();
                    reloadWithActiveTab('bracket')
                } else {
                    alert(result.message || '저장에 실패했습니다.');
                }
            } catch (error) {
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        // openMatchRecordModal, openVideographerModal, deleteMatchRecord, saveVideographer, sortTable, stylePlayerName 함수들은 여기에 그대로 유지...
        // (이전 답변과 동일하므로 생략)
        function openMatchRecordModal(cell, modalInstance) {
            const form = document.getElementById('matchRecordForm');
            form.reset();
            const matchDataStr = cell.dataset.match;
            const match = matchDataStr ? JSON.parse(decodeURIComponent(matchDataStr)) : null;
            const playerNames = <%- selectedSchedule && allPlayers ? JSON.stringify(allPlayers.map(p => p.name)) : '[]' %>;
            const datalist = document.getElementById('modal-player-list');
            datalist.innerHTML = '';
            playerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                datalist.appendChild(option);
            });
            form.querySelector('[name="schedule_id"]').value = cell.dataset.scheduleId;
            form.querySelector('[name="round_num"]').value = cell.dataset.round;
            form.querySelector('[name="court_num"]').value = cell.dataset.court;
            if (match) {
                form.querySelector('[name="id"]').value = match.id || '';
                form.querySelector('[name="team1_deuce"]').value = match.team1_deuce || '';
                form.querySelector('[name="team1_ad"]').value = match.team1_ad || '';
                form.querySelector('[name="team1_score"]').value = match.team1_score || 0;
                form.querySelector('[name="team2_deuce"]').value = match.team2_deuce || '';
                form.querySelector('[name="team2_ad"]').value = match.team2_ad || '';
                form.querySelector('[name="team2_score"]').value = match.team2_score || 0;
                document.getElementById('deleteMatchRecordBtn').style.display = 'block';
            } else {
                document.getElementById('deleteMatchRecordBtn').style.display = 'none';
            }
            modalInstance.show();
        }
        
        function openVideographerModal(cell, modalInstance) {
            const matchDataStr = cell.dataset.match;
            const match = matchDataStr ? JSON.parse(decodeURIComponent(matchDataStr)) : null;
            document.getElementById('videographerMatchId').value = match ? match.id : '';
            document.getElementById('videographerScheduleId').value = cell.dataset.scheduleId;
            document.getElementById('videographerRound').value = cell.dataset.round;
            document.getElementById('videographerCourt').value = cell.dataset.court;
            document.getElementById('videographerName').value = match ? match.videographer || '' : '';
            modalInstance.show();
        }

        async function deleteMatchRecord(modalInstance) {
            if (!confirm('정말로 이 경기 기록을 삭제하시겠습니까?')) return;
            const form = document.getElementById('matchRecordForm');
            const matchId = form.querySelector('[name="id"]').value;
            if (!matchId) {
                alert('삭제할 경기 기록이 없습니다.');
                return;
            }
            try {
                const response = await fetch('/api/special-match/record', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: matchId })
                });
                const result = await response.json();
                if (result.success) {
                    modalInstance.hide();
                    reloadWithActiveTab('bracket');
                } else {
                    alert(result.message || '삭제에 실패했습니다.');
                }
            } catch (error) {
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        async function saveVideographer(modalInstance) {
            const data = {
                id: document.getElementById('videographerMatchId').value,
                schedule_id: document.getElementById('videographerScheduleId').value,
                round_num: document.getElementById('videographerRound').value,
                court_num: document.getElementById('videographerCourt').value,
                videographer: document.getElementById('videographerName').value
            };
            try {
                const response = await fetch('/api/special-match/videographer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    modalInstance.hide();
                    reloadWithActiveTab('videographer');
                } else {
                    alert(result.message || '저장에 실패했습니다.');
                }
            } catch (error) {
                alert('오류가 발생했습니다: ' + error.message);
            }
        }
        
        let sortDirections = {};
        function sortTable(columnIndex, type) {
            const table = document.getElementById('player-score-table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const direction = sortDirections[columnIndex] === 'asc' ? 'desc' : 'asc';
            sortDirections[columnIndex] = direction;
            rows.sort((a, b) => {
                const valA = a.cells[columnIndex].innerText.trim();
                const valB = b.cells[columnIndex].innerText.trim();
                let compareA, compareB;
                if (type === 'number') {
                    compareA = parseFloat(valA.replace('+', ''));
                    compareB = parseFloat(valB.replace('+', ''));
                } else {
                    compareA = valA;
                    compareB = valB;
                }
                if (compareA < compareB) {
                    return direction === 'asc' ? -1 : 1;
                }
                if (compareA > compareB) {
                    return direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
            rows.forEach(row => tbody.appendChild(row));
        }

        const genderMap = JSON.parse('<%- JSON.stringify(genderMap || {}) %>');
        const stylePlayerName = (playerName, genderMap) => {
            if (!playerName) return ''; 
            const gender = genderMap[playerName];
            let genderClass = '';
            if (gender === '남') genderClass = 'text-male';
            else if (gender === '여') genderClass = 'text-female';
            if (genderClass) {
            return `<span class="${genderClass}">${playerName}</span>`;
            }
            return playerName;
        };
    </script>
</body>
</html>